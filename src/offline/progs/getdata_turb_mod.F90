MODULE GETDATA_TURB_MOD

USE ARRAYS_MANIP, ONLY: SETUP, REPLICATE, NPROMIZE, INTERPOLATE, SET
USE PARKIND1, ONLY: JPRD

IMPLICIT NONE

CONTAINS

SUBROUTINE GETDATA_TURB (NPROMA, NGPBLKS, NFLEVG, KRR, KRRL, KRRI, KSV, KLEV, &
                        !IN and INOUT (allocation and reading)
                        &ZDXX_B, ZDYY_B, ZDZZ_B, ZDZX_B, ZDZY_B, ZZZ_B, &
                        &ZDIRCOSXW_B, ZDIRCOSYW_B, ZDIRCOSZW_B, ZCOSSLOPE_B, ZSINSLOPE_B, &
                        &PRHODJ_B, PTHVREF_B, &
                        &PSFTH_B, PSFRV_B, PSFU_B, PSFV_B, PSFSV_B, &
                        &PPABSM_B, PUM_B, PVM_B, PWM_B, PTKEM_B, ZSVM_B, PSRCM_B, &
                        &PLENGTHM_B, PLENGTHH_B, MFMOIST_B, &
                        &ZBL_DEPTH_B, ZSBL_DEPTH_B, &
                        &ZCEI_B, &
                        &PTHM_B, ZRM_B, &
                        &PRUS_B, PRVS_B, PRWS_B, PRTHS_B, ZRRS_B, ZRSVS_B, PRTKES_OUT_B, &
                        &PFLXZTHVMF_B, PFLXZUMF_B, PFLXZVMF_B, &
                        &PHGRAD_B, PZS_B, PSEA_UCU_B, PSEA_VCU_B, &
                        !OUT (allocation)
                        &PSIGS_B, &
                        &ZWTH_B,ZWRC_B,ZWSV_B,PDP_B,PTP_B,PTDIFF_B,PTDISS_B, &
                        &PEDR_B,PTPMF_B, &
                        &PDRUS_TURB_B,PDRVS_TURB_B, &
                        &PDRTHLS_TURB_B,PDRRTS_TURB_B,ZDRSVS_TURB_B, &
                        !OUT and INOUT (expected values)
                        &ZBL_DEPTH_OUT_B, ZSBL_DEPTH_OUT_B, &
                        &PTHM_OUT_B, ZRM_OUT_B, &
                        &PRUS_OUT_B, PRVS_OUT_B, PRWS_OUT_B, PRTHS_OUT_B, ZRRS_OUT_B, ZRSVS_OUT_B, PRTKES_OUT_OUT_B, &
                        &PSIGS_OUT_B, &
                        &ZWTH_OUT_B, ZWRC_OUT_B, ZWSV_OUT_B, PDP_OUT_B, PTP_OUT_B, PTDIFF_OUT_B, PTDISS_OUT_B, &
                        &PEDR_OUT_B, PTPMF_OUT_B, &
                        &PDRUS_TURB_OUT_B, PDRVS_TURB_OUT_B, &
                        &PDRTHLS_TURB_OUT_B, PDRRTS_TURB_OUT_B, ZDRSVS_TURB_OUT_B, LDVERBOSE)

IMPLICIT NONE

INTEGER, PARAMETER :: IFILE = 77

INTEGER      :: KLON 
INTEGER, INTENT(OUT)      :: KLEV  
INTEGER, INTENT(OUT)      :: KRR, KRRL, KRRI
INTEGER, INTENT(OUT)      :: KSV
INTEGER      :: KDUM

LOGICAL, INTENT(IN) :: LDVERBOSE

!IN and INOUTS
REAL, INTENT(OUT), ALLOCATABLE   :: ZDXX_B             (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZDYY_B             (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZDZZ_B             (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZDZX_B             (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZDZY_B             (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZZZ_B              (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZDIRCOSXW_B        (:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZDIRCOSYW_B        (:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZDIRCOSZW_B        (:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZCOSSLOPE_B        (:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZSINSLOPE_B        (:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PRHODJ_B           (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PTHVREF_B          (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PSFTH_B            (:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PSFRV_B            (:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PSFU_B             (:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PSFV_B             (:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PSFSV_B            (:,:,:) !(KLON, 1, KSV)
REAL, INTENT(OUT), ALLOCATABLE   :: PPABSM_B           (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PUM_B              (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PVM_B              (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PWM_B              (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PTKEM_B            (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZSVM_B             (:,:,:,:) !(KLON,1,KLEV+2,KSV)
REAL, INTENT(OUT), ALLOCATABLE   :: PSRCM_B            (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PLENGTHM_B         (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PLENGTHH_B         (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: MFMOIST_B          (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZBL_DEPTH_B        (:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZSBL_DEPTH_B       (:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZCEI_B             (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PTHM_B             (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZRM_B              (:,:,:,:) !(KLON,1,KLEV+2,KRR)
REAL, INTENT(OUT), ALLOCATABLE   :: PRUS_B             (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PRVS_B             (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PRWS_B             (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PRTHS_B            (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZRRS_B             (:,:,:,:) !(KLON,1,KLEV+2,KRR)
REAL, INTENT(OUT), ALLOCATABLE   :: ZRSVS_B            (:,:,:,:) !(KLON,1,KLEV+2,KSV)
REAL, INTENT(OUT), ALLOCATABLE   :: PRTKES_OUT_B       (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PFLXZTHVMF_B       (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PFLXZUMF_B         (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PFLXZVMF_B         (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PHGRAD_B           (:,:,:,:) !(KLON,1,KLEV+2,KGRADIENTS)
REAL, INTENT(OUT), ALLOCATABLE   :: PZS_B              (:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PSEA_UCU_B         (:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PSEA_VCU_B         (:,:)

!OUT
REAL, INTENT(OUT), ALLOCATABLE   :: PSIGS_B            (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZWTH_B             (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZWRC_B             (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZWSV_B             (:,:,:,:) !(KLON,1,KLEV+2,KSV)
REAL, INTENT(OUT), ALLOCATABLE   :: PDP_B              (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PTP_B              (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PTDIFF_B           (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PTDISS_B           (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PEDR_B             (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PTPMF_B            (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PDRUS_TURB_B       (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PDRVS_TURB_B       (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PDRTHLS_TURB_B     (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PDRRTS_TURB_B      (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZDRSVS_TURB_B      (:,:,:,:) !(KLON,1,KLEV+2,KSV)

!Expected values
REAL, INTENT(OUT), ALLOCATABLE   :: ZBL_DEPTH_OUT_B    (:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZSBL_DEPTH_OUT_B   (:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PTHM_OUT_B         (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZRM_OUT_B          (:,:,:,:) !(KLON,1,KLEV+2,KRR)
REAL, INTENT(OUT), ALLOCATABLE   :: PRUS_OUT_B         (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PRVS_OUT_B         (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PRWS_OUT_B         (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PRTHS_OUT_B        (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZRRS_OUT_B         (:,:,:,:) !(KLON,1,KLEV+2,KRR)
REAL, INTENT(OUT), ALLOCATABLE   :: ZRSVS_OUT_B        (:,:,:,:) !(KLON,1,KLEV+2,KSV) 
REAL, INTENT(OUT), ALLOCATABLE   :: PRTKES_OUT_OUT_B   (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PSIGS_OUT_B        (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZWTH_OUT_B         (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZWRC_OUT_B         (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZWSV_OUT_B         (:,:,:,:) !(KLON,1,KLEV+2,KSV)
REAL, INTENT(OUT), ALLOCATABLE   :: PDP_OUT_B          (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PTP_OUT_B          (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PTDIFF_OUT_B       (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PTDISS_OUT_B       (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PEDR_OUT_B         (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PTPMF_OUT_B        (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PDRUS_TURB_OUT_B   (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PDRVS_TURB_OUT_B   (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PDRTHLS_TURB_OUT_B (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: PDRRTS_TURB_OUT_B  (:,:,:)
REAL, INTENT(OUT), ALLOCATABLE   :: ZDRSVS_TURB_OUT_B  (:,:,:,:) !(KLON,1,KLEV+2,KSV)

!Inputs to read
REAL(KIND=JPRD), ALLOCATABLE   :: ZDXX               (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZDYY               (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZDZZ               (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZDZX               (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZDZY               (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZZZ                (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZDIRCOSXW          (:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZDIRCOSYW          (:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZDIRCOSZW          (:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZCOSSLOPE          (:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZSINSLOPE          (:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PRHODJ             (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PTHVREF            (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PSFTH              (:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PSFRV              (:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PSFU               (:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PSFV               (:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PSFSV              (:,:,:) !(KLON, 1, KSV)
REAL(KIND=JPRD), ALLOCATABLE   :: PPABSM             (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PUM                (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PVM                (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PWM                (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PTKEM              (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZSVM               (:,:,:,:) !(KLON,1,KLEV+2,KSV)
REAL(KIND=JPRD), ALLOCATABLE   :: PSRCM              (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PLENGTHM           (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PLENGTHH           (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: MFMOIST            (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZBL_DEPTH          (:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZSBL_DEPTH         (:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZCEI               (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PTHM               (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZRM                (:,:,:,:) !(KLON,1,KLEV+2,KRR)
REAL(KIND=JPRD), ALLOCATABLE   :: PRUS               (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PRVS               (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PRWS               (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PRTHS              (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZRRS               (:,:,:,:) !(KLON,1,KLEV+2,KRR)
REAL(KIND=JPRD), ALLOCATABLE   :: ZRSVS              (:,:,:,:) !(KLON,1,KLEV+2,KSV)
REAL(KIND=JPRD), ALLOCATABLE   :: PRTKES_OUT         (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PFLXZTHVMF         (:,:,:)
!Expected values to read
REAL(KIND=JPRD), ALLOCATABLE   :: ZBL_DEPTH_OUT      (:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZSBL_DEPTH_OUT     (:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PTHM_OUT           (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZRM_OUT            (:,:,:,:) !(KLON,1,KLEV+2,KRR)
REAL(KIND=JPRD), ALLOCATABLE   :: PRUS_OUT           (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PRVS_OUT           (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PRWS_OUT           (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PRTHS_OUT          (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZRRS_OUT           (:,:,:,:) !(KLON,1,KLEV+2,KRR)
REAL(KIND=JPRD), ALLOCATABLE   :: ZRSVS_OUT          (:,:,:,:) !(KLON,1,KLEV+2,KSV)
REAL(KIND=JPRD), ALLOCATABLE   :: PRTKES_OUT_OUT     (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PSIGS_OUT          (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZWTH_OUT           (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZWRC_OUT           (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZWSV_OUT           (:,:,:,:) !(KLON,1,KLEV+2,KSV)
REAL(KIND=JPRD), ALLOCATABLE   :: PDP_OUT            (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PTP_OUT            (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PTDIFF_OUT         (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PTDISS_OUT         (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PEDR_OUT           (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PTPMF_OUT          (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PDRUS_TURB_OUT     (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PDRVS_TURB_OUT     (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PDRTHLS_TURB_OUT   (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: PDRRTS_TURB_OUT    (:,:,:)
REAL(KIND=JPRD), ALLOCATABLE   :: ZDRSVS_TURB_OUT    (:,:,:,:) !(KLON,1,KLEV+2,KSV)

INTEGER, INTENT(IN) :: NPROMA, NGPBLKS
INTEGER :: NGPTOT
INTEGER, INTENT(INOUT) :: NFLEVG
INTEGER :: IOFF, IBL
LOGICAL :: LLEXIST
CHARACTER(LEN=32) :: CLFILE

CALL SETUP()

NGPTOT = NPROMA * NGPBLKS

IBL = 1
WRITE (CLFILE, '("data/",I8.8,".dat")') IBL
OPEN (IFILE, FILE=TRIM (CLFILE), FORM='UNFORMATTED') 
READ (IFILE) KLON, KDUM, KLEV
READ (IFILE) KRR, KRRL, KRRI, KSV
CLOSE (IFILE)

IF (NFLEVG < 0) NFLEVG = KLEV

ALLOCATE (ZDXX_B             (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZDYY_B             (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZDZZ_B             (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZDZX_B             (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZDZY_B             (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZZZ_B              (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZDIRCOSXW_B        (NPROMA,NGPBLKS))
ALLOCATE (ZDIRCOSYW_B        (NPROMA,NGPBLKS))
ALLOCATE (ZDIRCOSZW_B        (NPROMA,NGPBLKS))
ALLOCATE (ZCOSSLOPE_B        (NPROMA,NGPBLKS))
ALLOCATE (ZSINSLOPE_B        (NPROMA,NGPBLKS))
ALLOCATE (PRHODJ_B           (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PTHVREF_B          (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PSFTH_B            (NPROMA,NGPBLKS))
ALLOCATE (PSFRV_B            (NPROMA,NGPBLKS))
ALLOCATE (PSFU_B             (NPROMA,NGPBLKS))
ALLOCATE (PSFV_B             (NPROMA,NGPBLKS))
ALLOCATE (PSFSV_B            (NPROMA,KSV,NGPBLKS))
ALLOCATE (PPABSM_B           (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PUM_B              (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PVM_B              (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PWM_B              (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PTKEM_B            (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZSVM_B             (NPROMA,NFLEVG,KSV,NGPBLKS))
ALLOCATE (PSRCM_B            (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PLENGTHM_B         (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PLENGTHH_B         (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (MFMOIST_B          (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZBL_DEPTH_B        (NPROMA,NGPBLKS))
ALLOCATE (ZSBL_DEPTH_B       (NPROMA,NGPBLKS))
ALLOCATE (ZCEI_B             (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PTHM_B             (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZRM_B              (NPROMA,NFLEVG,KRR,NGPBLKS))
ALLOCATE (PRUS_B             (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PRVS_B             (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PRWS_B             (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PRTHS_B            (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZRRS_B             (NPROMA,NFLEVG,KRR,NGPBLKS))
ALLOCATE (ZRSVS_B            (NPROMA,NFLEVG,KSV,NGPBLKS))
ALLOCATE (PRTKES_OUT_B       (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PFLXZTHVMF_B       (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PFLXZUMF_B         (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PFLXZVMF_B         (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PHGRAD_B           (NPROMA,NFLEVG,0,NGPBLKS))
ALLOCATE (PZS_B              (NPROMA,NGPBLKS))
ALLOCATE (PSEA_UCU_B         (NPROMA,NGPBLKS))
ALLOCATE (PSEA_VCU_B         (NPROMA,NGPBLKS))

ALLOCATE (PSIGS_B            (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZWTH_B             (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZWRC_B             (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZWSV_B             (NPROMA,NFLEVG,KSV,NGPBLKS))
ALLOCATE (PDP_B              (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PTP_B              (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PTDIFF_B           (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PTDISS_B           (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PEDR_B             (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PTPMF_B            (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PDRUS_TURB_B       (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PDRVS_TURB_B       (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PDRTHLS_TURB_B     (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PDRRTS_TURB_B      (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZDRSVS_TURB_B      (NPROMA,NFLEVG,KSV,NGPBLKS))

ALLOCATE (ZBL_DEPTH_OUT_B    (NPROMA,NGPBLKS))
ALLOCATE (ZSBL_DEPTH_OUT_B   (NPROMA,NGPBLKS))
ALLOCATE (PTHM_OUT_B         (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZRM_OUT_B          (NPROMA,NFLEVG,KRR,NGPBLKS))
ALLOCATE (PRUS_OUT_B         (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PRVS_OUT_B         (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PRWS_OUT_B         (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PRTHS_OUT_B        (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZRRS_OUT_B         (NPROMA,NFLEVG,KRR,NGPBLKS))
ALLOCATE (ZRSVS_OUT_B        (NPROMA,NFLEVG,KSV,NGPBLKS))
ALLOCATE (PRTKES_OUT_OUT_B   (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PSIGS_OUT_B        (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZWTH_OUT_B         (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZWRC_OUT_B         (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZWSV_OUT_B         (NPROMA,NFLEVG,KSV,NGPBLKS))
ALLOCATE (PDP_OUT_B          (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PTP_OUT_B          (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PTDIFF_OUT_B       (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PTDISS_OUT_B       (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PEDR_OUT_B         (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PTPMF_OUT_B        (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PDRUS_TURB_OUT_B   (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PDRVS_TURB_OUT_B   (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PDRTHLS_TURB_OUT_B (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (PDRRTS_TURB_OUT_B  (NPROMA,NFLEVG,NGPBLKS))
ALLOCATE (ZDRSVS_TURB_OUT_B  (NPROMA,NFLEVG,KSV,NGPBLKS))

CALL SET (ZDXX_B             )
CALL SET (ZDYY_B             )
CALL SET (ZDZZ_B             )
CALL SET (ZDZX_B             )
CALL SET (ZDZY_B             )
CALL SET (ZZZ_B              )
CALL SET (ZDIRCOSXW_B        )
CALL SET (ZDIRCOSYW_B        )
CALL SET (ZDIRCOSZW_B        )
CALL SET (ZCOSSLOPE_B        )
CALL SET (ZSINSLOPE_B        )
CALL SET (PRHODJ_B           )
CALL SET (PTHVREF_B          )
CALL SET (PSFTH_B            )
CALL SET (PSFRV_B            )
CALL SET (PSFU_B             )
CALL SET (PSFV_B             )
CALL SET (PSFSV_B            )
CALL SET (PPABSM_B           )
CALL SET (PUM_B              )
CALL SET (PVM_B              )
CALL SET (PWM_B              )
CALL SET (PTKEM_B            )
CALL SET (ZSVM_B             )
CALL SET (PSRCM_B            )
CALL SET (PLENGTHM_B         )
CALL SET (PLENGTHH_B         )
CALL SET (MFMOIST_B          )
CALL SET (ZBL_DEPTH_B        )
CALL SET (ZSBL_DEPTH_B       )
CALL SET (ZCEI_B             )
CALL SET (PTHM_B             )
CALL SET (ZRM_B              )
CALL SET (PRUS_B             )
CALL SET (PRVS_B             )
CALL SET (PRWS_B             )
CALL SET (PRTHS_B            )
CALL SET (ZRRS_B             )
CALL SET (ZRSVS_B            )
CALL SET (PRTKES_OUT_B       )
CALL SET (PFLXZTHVMF_B       )
CALL SET (PHGRAD_B           )
CALL SET (PZS_B              )
PSEA_UCU_B = 0.
PSEA_VCU_B = 0.

CALL SET (PSIGS_B            )
CALL SET (ZWTH_B             )
CALL SET (ZWRC_B             )
CALL SET (ZWSV_B             )
CALL SET (PDP_B              )
CALL SET (PTP_B              )
CALL SET (PTDIFF_B           )
CALL SET (PTDISS_B           )
CALL SET (PEDR_B             )
CALL SET (PTPMF_B            )
CALL SET (PDRUS_TURB_B       )
CALL SET (PDRVS_TURB_B       )
CALL SET (PDRTHLS_TURB_B     )
CALL SET (PDRRTS_TURB_B      )
CALL SET (ZDRSVS_TURB_B      )

CALL SET (ZBL_DEPTH_OUT_B    )
CALL SET (ZSBL_DEPTH_OUT_B   )
CALL SET (PTHM_OUT_B         )
CALL SET (ZRM_OUT_B          )
CALL SET (PRUS_OUT_B         )
CALL SET (PRVS_OUT_B         )
CALL SET (PRWS_OUT_B         )
CALL SET (PRTHS_OUT_B        )
CALL SET (ZRRS_OUT_B         )
CALL SET (ZRSVS_OUT_B        )
CALL SET (PRTKES_OUT_OUT_B   )
CALL SET (PSIGS_OUT_B        )
CALL SET (ZWTH_OUT_B         )
CALL SET (ZWRC_OUT_B         )
CALL SET (ZWSV_OUT_B         )
CALL SET (PDP_OUT_B          )
CALL SET (PTP_OUT_B          )
CALL SET (PTDIFF_OUT_B       )
CALL SET (PTDISS_OUT_B       )
CALL SET (PEDR_OUT_B         )
CALL SET (PTPMF_OUT_B        )
CALL SET (PDRUS_TURB_OUT_B   )
CALL SET (PDRVS_TURB_OUT_B   )
CALL SET (PDRTHLS_TURB_OUT_B )
CALL SET (PDRRTS_TURB_OUT_B  )
CALL SET (ZDRSVS_TURB_OUT_B  )

PFLXZUMF_B=0.
PFLXZVMF_B=0.

IOFF = 0
IBL = 0
LLEXIST = .TRUE.

DO WHILE(LLEXIST)
  IBL = IBL + 1
  WRITE (CLFILE, '("data/",I8.8,".dat")') IBL

  INQUIRE (FILE=TRIM (CLFILE), EXIST=LLEXIST)

  IF (LDVERBOSE) PRINT *, TRIM (CLFILE)

  IF (.NOT. LLEXIST) EXIT

  OPEN (IFILE, FILE=TRIM (CLFILE), FORM='UNFORMATTED') 
  
  READ (IFILE) KLON, KDUM, KLEV
  READ (IFILE) KRR, KRRL, KRRI, KSV

  IF (IBL == 1) THEN
    ALLOCATE (ZDXX               (NGPTOT,KLEV,1))
    ALLOCATE (ZDYY               (NGPTOT,KLEV,1))
    ALLOCATE (ZDZZ               (NGPTOT,KLEV,1))
    ALLOCATE (ZDZX               (NGPTOT,KLEV,1))
    ALLOCATE (ZDZY               (NGPTOT,KLEV,1))
    ALLOCATE (ZZZ                (NGPTOT,KLEV,1))
    ALLOCATE (ZDIRCOSXW          (NGPTOT,1))
    ALLOCATE (ZDIRCOSYW          (NGPTOT,1))
    ALLOCATE (ZDIRCOSZW          (NGPTOT,1))
    ALLOCATE (ZCOSSLOPE          (NGPTOT,1))
    ALLOCATE (ZSINSLOPE          (NGPTOT,1))
    ALLOCATE (PRHODJ             (NGPTOT,KLEV,1))
    ALLOCATE (PTHVREF            (NGPTOT,KLEV,1))
    ALLOCATE (PSFTH              (NGPTOT,1))
    ALLOCATE (PSFRV              (NGPTOT,1))
    ALLOCATE (PSFU               (NGPTOT,1))
    ALLOCATE (PSFV               (NGPTOT,1))
    ALLOCATE (PSFSV              (NGPTOT,KSV,1))
    ALLOCATE (PPABSM             (NGPTOT,KLEV,1))
    ALLOCATE (PUM                (NGPTOT,KLEV,1))
    ALLOCATE (PVM                (NGPTOT,KLEV,1))
    ALLOCATE (PWM                (NGPTOT,KLEV,1))
    ALLOCATE (PTKEM              (NGPTOT,KLEV,1))
    ALLOCATE (ZSVM               (NGPTOT,KLEV,KSV,1))
    ALLOCATE (PSRCM              (NGPTOT,KLEV,1))
    ALLOCATE (PLENGTHM           (NGPTOT,KLEV,1))
    ALLOCATE (PLENGTHH           (NGPTOT,KLEV,1))
    ALLOCATE (MFMOIST            (NGPTOT,KLEV,1))
    ALLOCATE (ZBL_DEPTH          (NGPTOT,1))
    ALLOCATE (ZSBL_DEPTH         (NGPTOT,1))
    ALLOCATE (ZCEI               (NGPTOT,KLEV,1))
    ALLOCATE (PTHM               (NGPTOT,KLEV,1))
    ALLOCATE (ZRM                (NGPTOT,KLEV,KRR,1))
    ALLOCATE (PRUS               (NGPTOT,KLEV,1))
    ALLOCATE (PRVS               (NGPTOT,KLEV,1))
    ALLOCATE (PRWS               (NGPTOT,KLEV,1))
    ALLOCATE (PRTHS              (NGPTOT,KLEV,1))
    ALLOCATE (ZRRS               (NGPTOT,KLEV,KRR,1))
    ALLOCATE (ZRSVS              (NGPTOT,KLEV,KSV,1))
    ALLOCATE (PRTKES_OUT         (NGPTOT,KLEV,1))
    ALLOCATE (PFLXZTHVMF         (NGPTOT,KLEV,1))

    ALLOCATE (ZBL_DEPTH_OUT      (NGPTOT,1))
    ALLOCATE (ZSBL_DEPTH_OUT     (NGPTOT,1))
    ALLOCATE (PTHM_OUT           (NGPTOT,KLEV,1))
    ALLOCATE (ZRM_OUT            (NGPTOT,KLEV,KRR,1))
    ALLOCATE (PRUS_OUT           (NGPTOT,KLEV,1))
    ALLOCATE (PRVS_OUT           (NGPTOT,KLEV,1))
    ALLOCATE (PRWS_OUT           (NGPTOT,KLEV,1))
    ALLOCATE (PRTHS_OUT          (NGPTOT,KLEV,1))
    ALLOCATE (ZRRS_OUT           (NGPTOT,KLEV,KRR,1))
    ALLOCATE (ZRSVS_OUT          (NGPTOT,KLEV,KSV,1))
    ALLOCATE (PRTKES_OUT_OUT     (NGPTOT,KLEV,1))
    ALLOCATE (PSIGS_OUT          (NGPTOT,KLEV,1))
    ALLOCATE (ZWTH_OUT           (NGPTOT,KLEV,1))
    ALLOCATE (ZWRC_OUT           (NGPTOT,KLEV,1))
    ALLOCATE (ZWSV_OUT           (NGPTOT,KLEV,KSV,1))
    ALLOCATE (PDP_OUT            (NGPTOT,KLEV,1))
    ALLOCATE (PTP_OUT            (NGPTOT,KLEV,1))
    ALLOCATE (PTDIFF_OUT         (NGPTOT,KLEV,1))
    ALLOCATE (PTDISS_OUT         (NGPTOT,KLEV,1))
    ALLOCATE (PEDR_OUT           (NGPTOT,KLEV,1))
    ALLOCATE (PTPMF_OUT          (NGPTOT,KLEV,1))
    ALLOCATE (PDRUS_TURB_OUT     (NGPTOT,KLEV,1))
    ALLOCATE (PDRVS_TURB_OUT     (NGPTOT,KLEV,1))
    ALLOCATE (PDRTHLS_TURB_OUT   (NGPTOT,KLEV,1))
    ALLOCATE (PDRRTS_TURB_OUT    (NGPTOT,KLEV,1))
    ALLOCATE (ZDRSVS_TURB_OUT    (NGPTOT,KLEV,KSV,1))
  ENDIF

  IF (IOFF+KLON > NGPTOT) THEN
    EXIT
  ENDIF

  READ(IFILE) ZDXX               (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZDYY               (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZDZZ               (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZDZX               (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZDZY               (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZZZ                (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZDIRCOSXW          (IOFF+1:IOFF+KLON,1)
  READ(IFILE) ZDIRCOSYW          (IOFF+1:IOFF+KLON,1)
  READ(IFILE) ZDIRCOSZW          (IOFF+1:IOFF+KLON,1)
  READ(IFILE) ZCOSSLOPE          (IOFF+1:IOFF+KLON,1)
  READ(IFILE) ZSINSLOPE          (IOFF+1:IOFF+KLON,1)
  READ(IFILE) PRHODJ             (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PTHVREF            (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PSFTH              (IOFF+1:IOFF+KLON,1)
  READ(IFILE) PSFRV              (IOFF+1:IOFF+KLON,1)
  READ(IFILE) PSFU               (IOFF+1:IOFF+KLON,1)
  READ(IFILE) PSFV               (IOFF+1:IOFF+KLON,1)
  READ(IFILE) PSFSV              (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PPABSM             (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PUM                (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PVM                (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PWM                (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PTKEM              (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZSVM               (IOFF+1:IOFF+KLON,:,:,1)
  READ(IFILE) PSRCM              (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PLENGTHM           (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PLENGTHH           (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) MFMOIST            (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZBL_DEPTH          (IOFF+1:IOFF+KLON,1)
  READ(IFILE) ZSBL_DEPTH         (IOFF+1:IOFF+KLON,1)
  READ(IFILE) ZCEI               (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PTHM               (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZRM                (IOFF+1:IOFF+KLON,:,:,1)
  READ(IFILE) PRUS               (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PRVS               (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PRWS               (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PRTHS              (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZRRS               (IOFF+1:IOFF+KLON,:,:,1)
  READ(IFILE) ZRSVS              (IOFF+1:IOFF+KLON,:,:,1)
  READ(IFILE) PRTKES_OUT         (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PFLXZTHVMF         (IOFF+1:IOFF+KLON,:,1)

  READ(IFILE) ZBL_DEPTH_OUT      (IOFF+1:IOFF+KLON,1)
  READ(IFILE) ZSBL_DEPTH_OUT     (IOFF+1:IOFF+KLON,1)
  READ(IFILE) PTHM_OUT           (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZRM_OUT            (IOFF+1:IOFF+KLON,:,:,1)
  READ(IFILE) PRUS_OUT           (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PRVS_OUT           (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PRWS_OUT           (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PRTHS_OUT          (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZRRS_OUT           (IOFF+1:IOFF+KLON,:,:,1)
  READ(IFILE) ZRSVS_OUT          (IOFF+1:IOFF+KLON,:,:,1)
  READ(IFILE) PRTKES_OUT_OUT     (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PSIGS_OUT          (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZWTH_OUT           (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZWRC_OUT           (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZWSV_OUT           (IOFF+1:IOFF+KLON,:,:,1)
  READ(IFILE) PDP_OUT            (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PTP_OUT            (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PTDIFF_OUT         (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PTDISS_OUT         (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PEDR_OUT           (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PTPMF_OUT          (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PDRUS_TURB_OUT     (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PDRVS_TURB_OUT     (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PDRTHLS_TURB_OUT   (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) PDRRTS_TURB_OUT    (IOFF+1:IOFF+KLON,:,1)
  READ(IFILE) ZDRSVS_TURB_OUT    (IOFF+1:IOFF+KLON,:,:,1)
  
  CLOSE (IFILE)

  IOFF = IOFF + KLON

ENDDO

IF (NFLEVG /= KLEV) THEN
  CALL INTERPOLATE (NFLEVG, IOFF, ZDXX               )
  CALL INTERPOLATE (NFLEVG, IOFF, ZDYY               )
  CALL INTERPOLATE (NFLEVG, IOFF, ZDZZ               )
  CALL INTERPOLATE (NFLEVG, IOFF, ZDZX               )
  CALL INTERPOLATE (NFLEVG, IOFF, ZDZY               )
  CALL INTERPOLATE (NFLEVG, IOFF, ZZZ                )
!  CALL INTERPOLATE (NFLEVG, IOFF, ZDIRCOSXW_B        )
!  CALL INTERPOLATE (NFLEVG, IOFF, ZDIRCOSYW_B        )
!  CALL INTERPOLATE (NFLEVG, IOFF, ZDIRCOSZW_B        )
!  CALL INTERPOLATE (NFLEVG, IOFF, ZCOSSLOPE          )
!  CALL INTERPOLATE (NFLEVG, IOFF, ZSINSLOPE          )
  CALL INTERPOLATE (NFLEVG, IOFF, PRHODJ             )
  CALL INTERPOLATE (NFLEVG, IOFF, PTHVREF            )
!  CALL INTERPOLATE (NFLEVG, IOFF, PSFTH              )
!  CALL INTERPOLATE (NFLEVG, IOFF, PSFRV              )
!  CALL INTERPOLATE (NFLEVG, IOFF, PSFU               )
!  CALL INTERPOLATE (NFLEVG, IOFF, PSFV               )
!  CALL INTERPOLATE (NFLEVG, IOFF, PSFSV              )
  CALL INTERPOLATE (NFLEVG, IOFF, PPABSM             )
  CALL INTERPOLATE (NFLEVG, IOFF, PUM                )
  CALL INTERPOLATE (NFLEVG, IOFF, PVM                )
  CALL INTERPOLATE (NFLEVG, IOFF, PWM                )
  CALL INTERPOLATE (NFLEVG, IOFF, PTKEM              )
  CALL INTERPOLATE (NFLEVG, IOFF, ZSVM               )
  CALL INTERPOLATE (NFLEVG, IOFF, PSRCM              )
  CALL INTERPOLATE (NFLEVG, IOFF, PLENGTHM           )
  CALL INTERPOLATE (NFLEVG, IOFF, PLENGTHH           )
  CALL INTERPOLATE (NFLEVG, IOFF, MFMOIST            )
!  CALL INTERPOLATE (NFLEVG, IOFF, ZBL_DEPTH          )
!  CALL INTERPOLATE (NFLEVG, IOFF, ZSBL_DEPTH         )
  CALL INTERPOLATE (NFLEVG, IOFF, ZCEI               )
  CALL INTERPOLATE (NFLEVG, IOFF, PTHM               )
  CALL INTERPOLATE (NFLEVG, IOFF, ZRM                )
  CALL INTERPOLATE (NFLEVG, IOFF, PRUS               )
  CALL INTERPOLATE (NFLEVG, IOFF, PRVS               )
  CALL INTERPOLATE (NFLEVG, IOFF, PRWS               )
  CALL INTERPOLATE (NFLEVG, IOFF, PRTHS              )
  CALL INTERPOLATE (NFLEVG, IOFF, ZRRS               )
  CALL INTERPOLATE (NFLEVG, IOFF, ZRSVS              )
  CALL INTERPOLATE (NFLEVG, IOFF, PRTKES_OUT         )
  CALL INTERPOLATE (NFLEVG, IOFF, PFLXZTHVMF         )

!  CALL INTERPOLATE (NFLEVG, IOFF, ZBL_DEPTH_OUT      )
!  CALL INTERPOLATE (NFLEVG, IOFF, ZSBL_DEPTH_OUT     )
  CALL INTERPOLATE (NFLEVG, IOFF, PTHM_OUT           )
  CALL INTERPOLATE (NFLEVG, IOFF, ZRM_OUT            )
  CALL INTERPOLATE (NFLEVG, IOFF, PRUS_OUT           )
  CALL INTERPOLATE (NFLEVG, IOFF, PRVS_OUT           )
  CALL INTERPOLATE (NFLEVG, IOFF, PRWS_OUT           )
  CALL INTERPOLATE (NFLEVG, IOFF, PRTHS_OUT          )
  CALL INTERPOLATE (NFLEVG, IOFF, ZRRS_OUT           )
  CALL INTERPOLATE (NFLEVG, IOFF, ZRSVS_OUT          )
  CALL INTERPOLATE (NFLEVG, IOFF, PRTKES_OUT_OUT     )
  CALL INTERPOLATE (NFLEVG, IOFF, PSIGS_OUT          )
  CALL INTERPOLATE (NFLEVG, IOFF, ZWTH_OUT           )
  CALL INTERPOLATE (NFLEVG, IOFF, ZWRC_OUT           )
  CALL INTERPOLATE (NFLEVG, IOFF, ZWSV_OUT           )
  CALL INTERPOLATE (NFLEVG, IOFF, PDP_OUT            )
  CALL INTERPOLATE (NFLEVG, IOFF, PTP_OUT            )
  CALL INTERPOLATE (NFLEVG, IOFF, PTDIFF_OUT         )
  CALL INTERPOLATE (NFLEVG, IOFF, PTDISS_OUT         )
  CALL INTERPOLATE (NFLEVG, IOFF, PEDR_OUT           )
  CALL INTERPOLATE (NFLEVG, IOFF, PTPMF_OUT          )
  CALL INTERPOLATE (NFLEVG, IOFF, PDRUS_TURB_OUT     )
  CALL INTERPOLATE (NFLEVG, IOFF, PDRVS_TURB_OUT     )
  CALL INTERPOLATE (NFLEVG, IOFF, PDRTHLS_TURB_OUT   )
  CALL INTERPOLATE (NFLEVG, IOFF, PDRRTS_TURB_OUT    )
  CALL INTERPOLATE (NFLEVG, IOFF, ZDRSVS_TURB_OUT    )

ENDIF

CALL REPLICATE (IOFF, ZDXX               (:,:,1))
CALL REPLICATE (IOFF, ZDYY               (:,:,1))
CALL REPLICATE (IOFF, ZDZZ               (:,:,1))
CALL REPLICATE (IOFF, ZDZX               (:,:,1))
CALL REPLICATE (IOFF, ZDZY               (:,:,1))
CALL REPLICATE (IOFF, ZZZ                (:,:,1))
CALL REPLICATE (IOFF, ZDIRCOSXW          (:,1))
CALL REPLICATE (IOFF, ZDIRCOSYW          (:,1))
CALL REPLICATE (IOFF, ZDIRCOSZW          (:,1))
CALL REPLICATE (IOFF, ZCOSSLOPE          (:,1))
CALL REPLICATE (IOFF, ZSINSLOPE          (:,1))
CALL REPLICATE (IOFF, PRHODJ             (:,:,1))
CALL REPLICATE (IOFF, PTHVREF            (:,:,1))
CALL REPLICATE (IOFF, PSFTH              (:,1))
CALL REPLICATE (IOFF, PSFRV              (:,1))
CALL REPLICATE (IOFF, PSFU               (:,1))
CALL REPLICATE (IOFF, PSFV               (:,1))
CALL REPLICATE (IOFF, PSFSV              (:,:,1))
CALL REPLICATE (IOFF, PPABSM             (:,:,1))
CALL REPLICATE (IOFF, PUM                (:,:,1))
CALL REPLICATE (IOFF, PVM                (:,:,1))
CALL REPLICATE (IOFF, PWM                (:,:,1))
CALL REPLICATE (IOFF, PTKEM              (:,:,1))
CALL REPLICATE (IOFF, ZSVM               (:,:,:,1))
CALL REPLICATE (IOFF, PSRCM              (:,:,1))
CALL REPLICATE (IOFF, PLENGTHM           (:,:,1))
CALL REPLICATE (IOFF, PLENGTHH           (:,:,1))
CALL REPLICATE (IOFF, MFMOIST            (:,:,1))
CALL REPLICATE (IOFF, ZBL_DEPTH          (:,1))
CALL REPLICATE (IOFF, ZSBL_DEPTH         (:,1))
CALL REPLICATE (IOFF, ZCEI               (:,:,1))
CALL REPLICATE (IOFF, PTHM               (:,:,1))
CALL REPLICATE (IOFF, ZRM                (:,:,:,1))
CALL REPLICATE (IOFF, PRUS               (:,:,1))
CALL REPLICATE (IOFF, PRVS               (:,:,1))
CALL REPLICATE (IOFF, PRWS               (:,:,1))
CALL REPLICATE (IOFF, PRTHS              (:,:,1))
CALL REPLICATE (IOFF, ZRRS               (:,:,:,1))
CALL REPLICATE (IOFF, ZRSVS              (:,:,:,1))
CALL REPLICATE (IOFF, PRTKES_OUT         (:,:,1))
CALL REPLICATE (IOFF, PFLXZTHVMF         (:,:,1))

CALL REPLICATE (IOFF, ZBL_DEPTH_OUT      (:,1))
CALL REPLICATE (IOFF, ZSBL_DEPTH_OUT     (:,1))
CALL REPLICATE (IOFF, PTHM_OUT           (:,:,1))
CALL REPLICATE (IOFF, ZRM_OUT            (:,:,:,1))
CALL REPLICATE (IOFF, PRUS_OUT           (:,:,1))
CALL REPLICATE (IOFF, PRVS_OUT           (:,:,1))
CALL REPLICATE (IOFF, PRWS_OUT           (:,:,1))
CALL REPLICATE (IOFF, PRTHS_OUT          (:,:,1))
CALL REPLICATE (IOFF, ZRRS_OUT           (:,:,:,1))
CALL REPLICATE (IOFF, ZRSVS_OUT          (:,:,:,1))
CALL REPLICATE (IOFF, PRTKES_OUT_OUT     (:,:,1))
CALL REPLICATE (IOFF, PSIGS_OUT          (:,:,1))
CALL REPLICATE (IOFF, ZWTH_OUT           (:,:,1))
CALL REPLICATE (IOFF, ZWRC_OUT           (:,:,1))
CALL REPLICATE (IOFF, ZWSV_OUT           (:,:,:,1))
CALL REPLICATE (IOFF, PDP_OUT            (:,:,1))
CALL REPLICATE (IOFF, PTP_OUT            (:,:,1))
CALL REPLICATE (IOFF, PTDIFF_OUT         (:,:,1))
CALL REPLICATE (IOFF, PTDISS_OUT         (:,:,1))
CALL REPLICATE (IOFF, PEDR_OUT           (:,:,1))
CALL REPLICATE (IOFF, PTPMF_OUT          (:,:,1))
CALL REPLICATE (IOFF, PDRUS_TURB_OUT     (:,:,1))
CALL REPLICATE (IOFF, PDRVS_TURB_OUT     (:,:,1))
CALL REPLICATE (IOFF, PDRTHLS_TURB_OUT   (:,:,1))
CALL REPLICATE (IOFF, PDRRTS_TURB_OUT    (:,:,1))
CALL REPLICATE (IOFF, ZDRSVS_TURB_OUT    (:,:,:,1))

CALL NPROMIZE (NPROMA, ZDXX               , ZDXX_B             )
CALL NPROMIZE (NPROMA, ZDYY               , ZDYY_B             )
CALL NPROMIZE (NPROMA, ZDZZ               , ZDZZ_B             )
CALL NPROMIZE (NPROMA, ZDZX               , ZDZX_B             )
CALL NPROMIZE (NPROMA, ZDZY               , ZDZY_B             )
CALL NPROMIZE (NPROMA, ZZZ                , ZZZ_B              )
CALL NPROMIZE (NPROMA, ZDIRCOSXW          , ZDIRCOSXW_B        )
CALL NPROMIZE (NPROMA, ZDIRCOSYW          , ZDIRCOSYW_B        )
CALL NPROMIZE (NPROMA, ZDIRCOSZW          , ZDIRCOSZW_B        )
CALL NPROMIZE (NPROMA, ZCOSSLOPE          , ZCOSSLOPE_B        )
CALL NPROMIZE (NPROMA, ZSINSLOPE          , ZSINSLOPE_B        )
CALL NPROMIZE (NPROMA, PRHODJ             , PRHODJ_B           )
CALL NPROMIZE (NPROMA, PTHVREF            , PTHVREF_B          )
CALL NPROMIZE (NPROMA, PSFTH              , PSFTH_B            )
CALL NPROMIZE (NPROMA, PSFRV              , PSFRV_B            )
CALL NPROMIZE (NPROMA, PSFU               , PSFU_B             )
CALL NPROMIZE (NPROMA, PSFV               , PSFV_B             )
CALL NPROMIZE (NPROMA, PSFSV              , PSFSV_B            )
CALL NPROMIZE (NPROMA, PPABSM             , PPABSM_B           )
CALL NPROMIZE (NPROMA, PUM                , PUM_B              )
CALL NPROMIZE (NPROMA, PVM                , PVM_B              )
CALL NPROMIZE (NPROMA, PWM                , PWM_B              )
CALL NPROMIZE (NPROMA, PTKEM              , PTKEM_B            )
CALL NPROMIZE (NPROMA, ZSVM               , ZSVM_B             )
CALL NPROMIZE (NPROMA, PSRCM              , PSRCM_B            )
CALL NPROMIZE (NPROMA, PLENGTHM           , PLENGTHM_B         ) 
CALL NPROMIZE (NPROMA, PLENGTHH           , PLENGTHH_B         ) 
CALL NPROMIZE (NPROMA, MFMOIST            , MFMOIST_B          ) 
CALL NPROMIZE (NPROMA, ZBL_DEPTH          , ZBL_DEPTH_B        ) 
CALL NPROMIZE (NPROMA, ZSBL_DEPTH         , ZSBL_DEPTH_B       ) 
CALL NPROMIZE (NPROMA, ZCEI               , ZCEI_B             ) 
CALL NPROMIZE (NPROMA, PTHM               , PTHM_B             )
CALL NPROMIZE (NPROMA, ZRM                , ZRM_B              )
CALL NPROMIZE (NPROMA, PRUS               , PRUS_B             )
CALL NPROMIZE (NPROMA, PRVS               , PRVS_B             )
CALL NPROMIZE (NPROMA, PRWS               , PRWS_B             )
CALL NPROMIZE (NPROMA, PRTHS              , PRTHS_B            )
CALL NPROMIZE (NPROMA, ZRRS               , ZRRS_B             )
CALL NPROMIZE (NPROMA, ZRSVS              , ZRSVS_B            )
CALL NPROMIZE (NPROMA, PRTKES_OUT         , PRTKES_OUT_B       )
CALL NPROMIZE (NPROMA, PFLXZTHVMF         , PFLXZTHVMF_B       )

CALL NPROMIZE (NPROMA, ZBL_DEPTH_OUT      , ZBL_DEPTH_OUT_B    )
CALL NPROMIZE (NPROMA, ZSBL_DEPTH_OUT     , ZSBL_DEPTH_OUT_B   )
CALL NPROMIZE (NPROMA, PTHM_OUT           , PTHM_OUT_B         )
CALL NPROMIZE (NPROMA, ZRM_OUT            , ZRM_OUT_B          )
CALL NPROMIZE (NPROMA, PRUS_OUT           , PRUS_OUT_B         )
CALL NPROMIZE (NPROMA, PRVS_OUT           , PRVS_OUT_B         )
CALL NPROMIZE (NPROMA, PRWS_OUT           , PRWS_OUT_B         )
CALL NPROMIZE (NPROMA, PRTHS_OUT          , PRTHS_OUT_B        )
CALL NPROMIZE (NPROMA, ZRRS_OUT           , ZRRS_OUT_B         )
CALL NPROMIZE (NPROMA, ZRSVS_OUT          , ZRSVS_OUT_B        )
CALL NPROMIZE (NPROMA, PRTKES_OUT_OUT     , PRTKES_OUT_OUT_B   )
CALL NPROMIZE (NPROMA, PSIGS_OUT          , PSIGS_OUT_B        )
CALL NPROMIZE (NPROMA, ZWTH_OUT           , ZWTH_OUT_B         )
CALL NPROMIZE (NPROMA, ZWRC_OUT           , ZWRC_OUT_B         )
CALL NPROMIZE (NPROMA, ZWSV_OUT           , ZWSV_OUT_B         )
CALL NPROMIZE (NPROMA, PDP_OUT            , PDP_OUT_B          )
CALL NPROMIZE (NPROMA, PTP_OUT            , PTP_OUT_B          )
CALL NPROMIZE (NPROMA, PTDIFF_OUT         , PTDIFF_OUT_B       )
CALL NPROMIZE (NPROMA, PTDISS_OUT         , PTDISS_OUT_B       )
CALL NPROMIZE (NPROMA, PEDR_OUT           , PEDR_OUT_B         )
CALL NPROMIZE (NPROMA, PTPMF_OUT          , PTPMF_OUT_B        )
CALL NPROMIZE (NPROMA, PDRUS_TURB_OUT     , PDRUS_TURB_OUT_B   )
CALL NPROMIZE (NPROMA, PDRVS_TURB_OUT     , PDRVS_TURB_OUT_B   )
CALL NPROMIZE (NPROMA, PDRTHLS_TURB_OUT   , PDRTHLS_TURB_OUT_B )
CALL NPROMIZE (NPROMA, PDRRTS_TURB_OUT    , PDRRTS_TURB_OUT_B  )
CALL NPROMIZE (NPROMA, ZDRSVS_TURB_OUT    , ZDRSVS_TURB_OUT_B  )

END SUBROUTINE 

END  MODULE
