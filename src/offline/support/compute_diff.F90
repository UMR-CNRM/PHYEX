MODULE COMPUTE_DIFF

IMPLICIT NONE

INTERFACE DIFF
  MODULE PROCEDURE DIFF2
  MODULE PROCEDURE DIFF1
END INTERFACE DIFF

CONTAINS

SUBROUTINE DIFF2 (CDNAME, PREF, POUT, LLSTAT, LLCHECK, NPROMA, LLCHECKDIFF, LLDIFF)
IMPLICIT NONE

CHARACTER (LEN=*), INTENT(IN) :: CDNAME
REAL, INTENT(IN) :: PREF (:,:)
REAL, INTENT(IN) :: POUT (:,:)
LOGICAL, INTENT(IN) :: LLSTAT, LLCHECK, LLCHECKDIFF
INTEGER, INTENT(IN) :: NPROMA
LOGICAL, INTENT(OUT) :: LLDIFF

INTEGER :: JLON, JLEV, KLEV

KLEV=SIZE(PREF, 2)

PRINT *, CDNAME
IF (LLSTAT) THEN
  PRINT *, MINVAL (PREF), MAXVAL (PREF), SUM (PREF) / SIZE (PREF)
  PRINT *, MINVAL (POUT), MAXVAL (POUT), SUM (POUT) / SIZE (POUT)
ENDIF

IF (LLCHECK) THEN
  IF (SUM (ABS (POUT) + ABS (PREF)) > 0) THEN
  WRITE (*, '(A4)', ADVANCE='NO') ""
  DO JLON = 1, NPROMA
    WRITE (*, '("|",I12,"..",A12)', ADVANCE='NO') JLON, ""
  ENDDO
  WRITE (*, '("|")')
  DO JLEV = 1, KLEV
    WRITE (*, '(I4)', ADVANCE='NO') JLEV
    DO JLON = 1, NPROMA
      IF (ABS (PREF (JLON, JLEV)) + ABS (POUT (JLON, JLEV)) == 0.) THEN
        WRITE (*, '("|",A12,"..",A12)', ADVANCE='NO') "", ""
      ELSE
        IF(ABS(POUT (JLON, JLEV)-PREF (JLON, JLEV))>0.001 * ABS(PREF (JLON, JLEV))) THEN
          WRITE (*, '("|",E12.5,"!=",E12.5)', ADVANCE='NO') PREF (JLON, JLEV), POUT (JLON, JLEV)
        ELSE
          WRITE (*, '("|",E12.5,"~=",E12.5)', ADVANCE='NO') PREF (JLON, JLEV), POUT (JLON, JLEV)
        ENDIF
      ENDIF
    ENDDO
    WRITE (*, '("|")')
  ENDDO
  ENDIF
ENDIF

IF (LLCHECKDIFF) THEN
  IF (SUM(ABS(POUT-PREF)) > 0.) THEN
    PRINT*, "THERE ARE DIFF"
    LLDIFF = .TRUE.
  ELSE
    PRINT*, "THERE IS NO DIFF"
  ENDIF
ENDIF

END SUBROUTINE

SUBROUTINE DIFF1 (CDNAME, PREF, POUT, LLSTAT, LLCHECK, NPROMA, LLCHECKDIFF, LLDIFF)
IMPLICIT NONE

CHARACTER (LEN=*), INTENT(IN) :: CDNAME
REAL, INTENT(IN) :: PREF (:)
REAL, INTENT(IN) :: POUT (:)
LOGICAL, INTENT(IN) :: LLSTAT, LLCHECK, LLCHECKDIFF
INTEGER, INTENT(IN) :: NPROMA
LOGICAL, INTENT(OUT) :: LLDIFF

INTEGER :: JLON

PRINT *, CDNAME
IF (LLSTAT) THEN
  PRINT *, MINVAL (PREF), MAXVAL (PREF), SUM (PREF) / SIZE (PREF)
  PRINT *, MINVAL (POUT), MAXVAL (POUT), SUM (POUT) / SIZE (POUT)
ENDIF

IF (LLCHECK) THEN
  IF (SUM (ABS (POUT) + ABS (PREF)) > 0) THEN
  WRITE (*, '(A4)', ADVANCE='NO') ""
  DO JLON = 1, NPROMA
    WRITE (*, '("|",I12,A12)', ADVANCE='NO') JLON, ""
  ENDDO
  WRITE (*, '("|")')
  WRITE (*, '(I4)', ADVANCE='NO') 0
  DO JLON = 1, NPROMA
    IF (ABS (PREF (JLON)) + ABS (POUT (JLON)) == 0.) THEN
    WRITE (*, '("|",2A12)', ADVANCE='NO') "", ""
    ELSE
    WRITE (*, '("|",2E12.5)', ADVANCE='NO') PREF (JLON), POUT (JLON)
    ENDIF
  ENDDO
  WRITE (*, '("|")')
  ENDIF
ENDIF

IF (LLCHECKDIFF) THEN
  IF (SUM(ABS(POUT-PREF)) > 0.) THEN
    PRINT*, "THERE ARE DIFF"
    LLDIFF = .TRUE.
  ELSE
    PRINT*, "THERE IS NO DIFF"
  ENDIF
ENDIF

END SUBROUTINE

END MODULE COMPUTE_DIFF
