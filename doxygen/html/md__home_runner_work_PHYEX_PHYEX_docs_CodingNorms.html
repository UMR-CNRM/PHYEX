<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PHYEX: PHYEX CODING NORMS DOCUMENTATION</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PHYEX
   </div>
   <div id="projectbrief">PHYsique EXternalisée</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">PHYEX CODING NORMS DOCUMENTATION </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md19"></a>
About this section</h1>
<p>This section is intended for developers and integrators and describes the coding norms to use.</p>
<h1><a class="anchor" id="autotoc_md20"></a>
Coding norms</h1>
<h2><a class="anchor" id="autotoc_md21"></a>
Namelists</h2>
<p>We must be able to reproduce (binary comparison of the output files) the model results before and after code modifications. It means that every modification must be controlled by a namelist key (with the exception of bug corrections).</p>
<h2><a class="anchor" id="autotoc_md22"></a>
File names</h2>
<p>The fortran file names use a capital F letter (eg: foo.F90) except if working in a Meso-NH branch (mesonh_&lt;commit&gt;) or in the folder (src/mesonh) specific to the Meso-NH model.</p>
<p>Names for the module:</p>
<ul>
<li>modd_ for module containing only variable declaration (eg: tuning parameters)</li>
<li>modi_ for module containing only interface declaration</li>
<li>modn_ for namelist declaration</li>
<li>mode_ for module containing executable source code (subroutine or function)</li>
</ul>
<h2><a class="anchor" id="autotoc_md23"></a>
When using mode_ or modi_?</h2>
<p>When writing a new subroutine, should we put it in a module (in a mode_ file) or should we write the subroutine in a file and write the interface bloc in another file (modi_ file)?</p>
<p>The answer depends on whether the routine is the 'main' routine of the parametrisation or not. If it is the 'main' routine, the interface bloc is declared apart, if not we can use a module. The idea behind is to break compilation dependency at the parametrisation level, and to isolate the interface declaration of the different routines that must be plugged in the hosting model.</p>
<h2><a class="anchor" id="autotoc_md24"></a>
Miscellaneous constraints</h2>
<p>Several constraints are imposed:</p>
<ul>
<li>The code must be written with up to 132 characters per line.</li>
<li>CODE IS IN CAPITAL LETTERS! comments in small letters</li>
<li>All variables must be declared: IMPLICIT NONE</li>
<li>except in rare cases, use automatic arrays, no allocatable</li>
<li>dimensions of dummy argument arrays are explicit (no (:,:))</li>
<li>except variables declared with the PARAMETER attribute, no variable from modules can be used in the physics. Variables must be put in a type received by interface.</li>
<li>functions returning arrays must be rewritten as subroutine</li>
</ul>
<h2><a class="anchor" id="autotoc_md25"></a>
Doctor norm</h2>
<p>The variables are named according to the doctor norm:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type / Status   </th><th class="markdownTableHeadNone">INTEGER   </th><th class="markdownTableHeadNone">REAL   </th><th class="markdownTableHeadNone">LOGICAL   </th><th class="markdownTableHeadNone">CHARACTER   </th><th class="markdownTableHeadNone">TYPE    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Global   </td><td class="markdownTableBodyNone">N   </td><td class="markdownTableBodyNone">X   </td><td class="markdownTableBodyNone">L (not LP)   </td><td class="markdownTableBodyNone">C   </td><td class="markdownTableBodyNone">T (not TP,TS,TZ)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Dummy argument   </td><td class="markdownTableBodyNone">K   </td><td class="markdownTableBodyNone">P (not PP)   </td><td class="markdownTableBodyNone">O   </td><td class="markdownTableBodyNone">H   </td><td class="markdownTableBodyNone">TP    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Local   </td><td class="markdownTableBodyNone">I (not IS)   </td><td class="markdownTableBodyNone">Z (not ZS)   </td><td class="markdownTableBodyNone">G (not GS)   </td><td class="markdownTableBodyNone">Y (not YS, YP)   </td><td class="markdownTableBodyNone">TZ    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Loop control   </td><td class="markdownTableBodyNone">J (not JP)   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">-   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md26"></a>
Array-syntax or not?</h2>
<p>The master branch and the Méso-NH specifc branches are written using array-syntax with mnh_expand directives.</p>
<p>For these branches, developer must be carrefull when using the mnh_expand directives, code must respect some constraints (the verify_mnh_expand.py tool can help the PHYEX admin at checking the validity of the written code):</p><ul>
<li>parenthesis after array variables are mandatory (no A=B+C, but A(:,:)=B(:,:)+C(:,:))</li>
<li>no space between array variables and the opening parenthesis (no A (:)=B (:), but A(:)=B(:))</li>
<li>same bounds as declared in the mnh_expand directive should be used in the array-syntax (A(DNIB:DNIE)=...)</li>
</ul>
<p>The arome and offline specific branches are written using DO loops.</p>
<h2><a class="anchor" id="autotoc_md27"></a>
Call to routines from within a loop on horizontal or vertical dimensions</h2>
<p>Call to external subroutine in loop on horizontal or vertical dimensions must be suppressed in the master version. If possible, the call must be put outside of the loop (acting on the full array as a whole) or the subroutine must be put in the CONTAINS part but, in this case, the included subroutine cannot use local array. There are 3 cases:</p>
<ul>
<li>the subroutine doesn't use local array: subroutine is put in an include file (with the .h extension) and included with the fortran INCLUDE statement.</li>
<li>the subroutine use local arrays but it is called from only one place in the code: the source code of the subroutine is moved (no INCLUDE) in the CONTAINS part and the array declarations are moved in the main subroutine.</li>
<li>the subroutine use local arrays and is called from several places: the previous technique is not recommended. The source code is put in an include file (with the .h extension) and an extra argument is provided to the subroutine and is used as a buffer so there is no more need to declare local arrays in the called subroutine.</li>
</ul>
<h2><a class="anchor" id="autotoc_md28"></a>
Budgets</h2>
<p>In Meso-NH, the budget can be used in two ways:</p>
<ul>
<li>by giving to the budget machinery the tendency due to a given process</li>
<li>by giving to the budget machinery the total tendency (S variable) before and after a given process. The budget mechanism recomputes by difference the tendency only due to the given process.</li>
</ul>
<p>In AROME, we cannot provide the total tendency (S variable) before the process. This total tendency is stored internally by the machinery but cannot be set to a different value before doing a computation.</p>
<p>The physics package must be usable from AROME and Meso-NH, several examples are given:</p>
<p>Invalid for AROME: </p><div class="fragment"><div class="line">budget_store_init(tempo_s)</div>
<div class="line">modification of tempo_s</div>
<div class="line">budget_store_end(tempo_s)</div>
</div><!-- fragment --><p>Valid: </p><div class="fragment"><div class="line">budget_store_init(pronostic_s) #useless for AROME, but needed for Meso-NH</div>
<div class="line">modification of pronostic_s</div>
<div class="line">budget_store_end(pronostic_s)</div>
</div><!-- fragment --><p>Valid: </p><div class="fragment"><div class="line">computation of delta tempo_s</div>
<div class="line">budget_store_add(delta tempo_s)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md29"></a>
Comments</h1>
<p>The code must contain comments to help futur developers.</p>
<p>In addition, those comments can be used by external tools, so they must be formatted correctly. At least two tools can be applied on the PHYEX source code.</p>
<p>Firstly, doxygen is used to build html pages documenting the source code. Unfortunately doxygen has limitations and only few comments can be reported on the html pages without rewritting the existing code (doxygen waits for comment before the subroutine and not inside):</p>
<ul>
<li>in a module file, the general documentation (just after the module statement) must begin by "!&gt; @file" on the first line and following lines must begin with a double exclamation mark "!!";</li>
<li>dummy arguments must be declared each one on a separate line followed by a comment strarting with "!&lt;".</li>
</ul>
<p>Secondly an home-made tool can extract comments on some variables to document the namelist keys. This tool waits for comment formatted as described for doxygen (one dummy argument by line followed by "!&lt;").</p>
<p>Here is an example with a complete template for a module containing a subroutine: </p><div class="fragment"><div class="line">!MNH_LIC Copyright 1995-2021 CNRS, Meteo-France and Universite Paul Sabatier</div>
<div class="line">!MNH_LIC This is part of the Meso-NH software governed by the CeCILL-C licence                                       </div>
<div class="line">!MNH_LIC version 1. See LICENSE, CeCILL-C_V1-en.txt and CeCILL-C_V1-fr.txt                                           </div>
<div class="line">!MNH_LIC for details. version 1.</div>
<div class="line">!-----------------------------------------------------------------</div>
<div class="line">MODULE MODE_FOO</div>
<div class="line">!&gt; @file</div>
<div class="line">!!These comments will be visible in doxygen and will be</div>
<div class="line">!!associated to the file containing this module</div>
<div class="line">!</div>
<div class="line">IMPLICIT NONE</div>
<div class="line">!</div>
<div class="line">TYPE FOO_t</div>
<div class="line">  REAL :: X1 !&lt; Documentation for X1, needed by doxygen and the tool used to ocument namelists</div>
<div class="line">END TYPE FOO_t</div>
<div class="line">!</div>
<div class="line">CONTAINS</div>
<div class="line">!</div>
<div class="line">SUBROUTINE FOO(K)</div>
<div class="line">!!*** *FOO* - short comment</div>
<div class="line">!!</div>
<div class="line">!!*   PURPOSE</div>
<div class="line">!!    -------</div>
<div class="line">!!    What the surbroutines does</div>
<div class="line">!!</div>
<div class="line">!!*   METHOD</div>
<div class="line">!!    ------</div>
<div class="line">!!    0. Declarations</div>
<div class="line">!!       1. Declaration of arguments</div>
<div class="line">!!       2. Declaration of local variables</div>
<div class="line">!!    1. Computation</div>
<div class="line">!!</div>
<div class="line">!!*   EXTERNAL</div>
<div class="line">!!    --------</div>
<div class="line">!!    subroutine XXX : to ...</div>
<div class="line">!!    subroutine YYY : to ...</div>
<div class="line">!!    module MODI_BAR : interface for the BAR subroutine</div>
<div class="line">!!</div>
<div class="line">!!*   IMPLICIT ARGUMENTS</div>
<div class="line">!!    ------------------</div>
<div class="line">!!    List of the different modules used</div>
<div class="line">!!</div>
<div class="line">!!*   REFERENCE</div>
<div class="line">!!    ---------</div>
<div class="line">!!    Reference paper, book...</div>
<div class="line">!!</div>
<div class="line">!!    AUTHOR</div>
<div class="line">!!    ------</div>
<div class="line">!!    Name of the author</div>
<div class="line">!!</div>
<div class="line">!!    MODIFICATIONS</div>
<div class="line">!!    -------------</div>
<div class="line">!!      Original    Month Year</div>
<div class="line">!!                  Month Year (contributor): descrption of the contribution</div>
<div class="line">!-------------------------------------------------------------------------------</div>
<div class="line">!</div>
<div class="line">!*      0. DECLARATIONS</div>
<div class="line">!       ---------------</div>
<div class="line">!</div>
<div class="line">USE MODI_BAR</div>
<div class="line">!</div>
<div class="line">!* 0.1. Declaration of arguments</div>
<div class="line">!       ------------------------</div>
<div class="line">!</div>
<div class="line">INTEGER, INTENT(IN) :: K !&lt; Documentation for K</div>
<div class="line">!</div>
<div class="line">!* 0.2 Declaration of local variables</div>
<div class="line">!      ------------------------------</div>
<div class="line">!</div>
<div class="line">INTEGER :: II</div>
<div class="line">!</div>
<div class="line">!*      1. COMPUTATION</div>
<div class="line">!       --------------</div>
<div class="line">!</div>
<div class="line">II=K</div>
<div class="line">END SUBROUTINE FOO</div>
<div class="line">!</div>
<div class="line">END MODULE MODE_FOO</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
