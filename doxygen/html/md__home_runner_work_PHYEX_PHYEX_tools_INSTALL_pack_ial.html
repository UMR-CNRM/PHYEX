<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PHYEX: INSTALLATION NEEDED FOR AROME COMPILATION WITH PHYEX</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PHYEX
   </div>
   <div id="projectbrief">PHYsique EXternalis√©e</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">INSTALLATION NEEDED FOR AROME COMPILATION WITH PHYEX </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md84"></a>
ABOUT THIS DOCUMENT</h1>
<p>This document is intended for persons who want to compile the AROME model using the PHYEX package. The installation described here is also needed in order to use the check_commit_ial.sh script which enable to check if a given commit reproduces a reference version.</p>
<p>This document is written using the markdown language. With pandoc, it can be converted to HTML (pandoc -s &lt;filename&gt;.md -o &lt;filename&gt;.html) or PDF (pandoc -V geometry:landscape -s &lt;filename&gt;.md -o &lt;filename&gt;.pdf).</p>
<p>This document describes how to build reference packs on sxphynh (ubuntu) and belenos. The following instructions focuse on the 'phyex' pack in which the physics have been put in a new gmkpack project, named phyex.</p>
<p>Another pack ('main') have been produced as a super-reference without code move. Only a recompilation has been done.</p>
<p>This document ends with instruction on how to use these packs. This step is now automatically performed with the prep_code.sh script.</p>
<p>The same installation guide applies to sxphynh and belenos except for some commands. The directory in which the repository lies is designated by the TRUNK variable. The $TRUNK dir can be put on a shared directory to share this installation among several users. Tools are designed and tested with TRUNK=&lt;git repository&gt;/tools/pack/</p>
<h1><a class="anchor" id="autotoc_md85"></a>
REFERENCE PACK CREATION</h1>
<h2><a class="anchor" id="autotoc_md86"></a>
Prerequiste</h2>
<p>gmkpack must be installed fypp python module must be instaled (pip3 install &ndash;user fypp)</p>
<h2><a class="anchor" id="autotoc_md87"></a>
Create the pack</h2>
<div class="fragment"><div class="line">version=01</div>
<div class="line">cycle=48t1 or cy48t3 (after commit XXX on 22 September 2022), or 49t0</div>
<div class="line">compiler=MPIGFORTRAN920DBL on ubuntu before cycle 49, OMPIGFORT920DBL for 49, MIMPIIFC1805 on belenos before 49, IMPIIFC2018 for 49</div>
<div class="line">gmkfile=${compiler}.GMAP on ubuntu, ${compiler}.EPONA on belenos</div>
<div class="line">option=xfftw on ubuntu before 49, x for 49, 2y on belenos before 49, x for 49</div>
<div class="line">export GMKTMP=/dev/shm</div>
<div class="line">hub=&#39;-K&#39; if cycle is 49 or upper, &#39;&#39; otherwise</div>
<div class="line">gmkpack -a $hub -r ${cycle} -b phyex -n $version -l ${compiler} -o ${option} -p masterodb -h $TRUNK/tools/pack/ #create main pack</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md88"></a>
Populate main pack with source code</h2>
<div class="fragment"><div class="line">if cycle is 49</div>
<div class="line">  cd $TRUNK/tools/pack/${cycle}_phyex.${version}.${compiler}.${option}/hub/local/src</div>
<div class="line">  if sxphynh; then</div>
<div class="line">    wget http://anonymous:mto@webdav.cnrm.meteo.fr/public/algo/khatib/src/hub49.tgz</div>
<div class="line">  else</div>
<div class="line">    ssh sxphynh.cnrm.meteo.fr &quot;wget http://anonymous:mto@webdav.cnrm.meteo.fr/public/algo/khatib/src/hub49.tgz -O -&quot; &gt; hub49.tgz</div>
<div class="line">  fi</div>
<div class="line">  tar xf hub49.tgz</div>
<div class="line">  rm -f hub49.tgz</div>
<div class="line">fi</div>
<div class="line"> </div>
<div class="line">cd $TRUNK/tools/pack/${cycle}_phyex.${version}.${compiler}.${option}/src/local</div>
<div class="line">if sxphynh; then</div>
<div class="line">  wget http://anonymous:mto@webdav.cnrm.meteo.fr/public/algo/khatib/src/${cycle}_main.01.tgz #only available at MF but equivalent must exist elsewhere</div>
<div class="line">else</div>
<div class="line">  ssh sxphynh.cnrm.meteo.fr &quot;wget http://anonymous:mto@webdav.cnrm.meteo.fr/public/algo/khatib/src/${cycle}_main.01.tgz -O -&quot; &gt; ${cycle}_main.01.tgz</div>
<div class="line">fi</div>
<div class="line">tar xf ${cycle}_main.01.tgz</div>
<div class="line">rm -f ${cycle}_main.01.tgz</div>
<div class="line">for rep in turb micro conv; do</div>
<div class="line">  mkdir -p phyex/$rep</div>
<div class="line">  mv -f mpa/$rep/internals/* phyex/$rep/</div>
<div class="line">  mv -f mpa/$rep/module/* phyex/$rep/</div>
<div class="line">  rmdir mpa/$rep/internals mpa/$rep/module</div>
<div class="line">done</div>
<div class="line">[ $cycle == 49t0 ] &amp;&amp; rm -rf oopsifs</div>
<div class="line">[ $cycle == 48t1 ] &amp;&amp; tar xf /cnrm/algo/khatib/drhook.c_for_ubuntu.tar #only on ubuntu</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md89"></a>
Apply some bug corrections</h2>
<div class="fragment"><div class="line">sed -i &#39;s/IF (LBUDGET_RH)/IF (LBUDGET_RH .AND. KRR==7)/&#39; mpa/micro/externals/aro_rain_ice.F90</div>
</div><!-- fragment --><p>Edition of arpifs/phys_dmn/apl_arome.F90 to modify (line 1573 in 48t1, 1496 in 48t3):</p>
<div class="fragment"><div class="line">IF (LMFSHAL .AND. (CMF_CLOUD==&#39;DIRE&#39;.OR.CMF_CLOUD==&#39;BIGA&#39;)) THEN</div>
<div class="line">  IOFF_MFSHAL=IOFF_MFSHAL+3</div>
<div class="line">  ...</div>
<div class="line">ENDIF</div>
</div><!-- fragment --><p>into (48t1):</p>
<div class="fragment"><div class="line">IF (LMFSHAL .AND. (CMF_CLOUD==&#39;DIRE&#39;.OR.CMF_CLOUD==&#39;BIGA&#39;)) THEN</div>
<div class="line">  IOFF_MFSHAL=IOFF_MFSHAL+3</div>
<div class="line">  ...</div>
<div class="line">ELSE</div>
<div class="line">  DO JLEV = 1, KLEV</div>
<div class="line">    ZRC_MF_(KIDIA:KFDIA,JLEV)=0._JPRB</div>
<div class="line">    ZRI_MF_(KIDIA:KFDIA,JLEV)=0._JPRB</div>
<div class="line">    ZCF_MF_(KIDIA:KFDIA,JLEV)=0._JPRB</div>
<div class="line">  ENDDO</div>
<div class="line">ENDIF</div>
</div><!-- fragment --><p>or (48t3, 49t0):</p>
<div class="fragment"><div class="line">IF (LMFSHAL .AND. (CMF_CLOUD==&#39;DIRE&#39;.OR.CMF_CLOUD==&#39;BIGA&#39;)) THEN</div>
<div class="line">  IOFF_MFSHAL=IOFF_MFSHAL+3</div>
<div class="line">  ...</div>
<div class="line">ELSE</div>
<div class="line">  DO JLEV = 1, YDCPG_OPTS%KFLEVG</div>
<div class="line">    ZRC_MF_(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,JLEV)=0._JPRB                         </div>
<div class="line">    ZRI_MF_(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,JLEV)=0._JPRB                         </div>
<div class="line">    ZCF_MF_(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,JLEV)=0._JPRB                         </div>
<div class="line">  ENDDO</div>
<div class="line">ENDIF</div>
</div><!-- fragment --><p>Edition of apl_arome.F90 to modify (line 1406 in 48t1, 1329 in 48t3, 1317 in 49t0):</p>
<div class="fragment"><div class="line">IF ( LKFBCONV.AND.LOSUBG_COND.AND..NOT.LOSIGMAS) THEN</div>
<div class="line">  DO JLEV = 1, KLEV</div>
<div class="line">    ZMFM_(...</div>
<div class="line">  ENDDO</div>
<div class="line">ENDIF</div>
</div><!-- fragment --><p>into:</p>
<div class="fragment"><div class="line">IF (LOSUBG_COND.AND..NOT.LOSIGMAS) THEN</div>
<div class="line">  IF (LKFBCONV) THEN</div>
<div class="line">    DO JLEV = 1, KLEV</div>
<div class="line">      ZMFM_(...</div>
<div class="line">    ENDDO</div>
<div class="line">  ELSE</div>
<div class="line">    DO JLEV = 1, KLEV</div>
<div class="line">      ZMFM_(...)=0._JPRB</div>
<div class="line">    ENDDO</div>
<div class="line">  ENDIF</div>
<div class="line">ENDIF</div>
</div><!-- fragment --><p>If cycle is 48t3 or 49t0, edition of apl_arome.F90 to modify (line 3616)</p>
<div class="fragment"><div class="line">ZTMP2(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,:)=ZFPR(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,:,2)+ZFPR(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,:,3)</div>
<div class="line">CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMP2(:,:),&#39;FQTPRECISTL&#39;,YDDDH)</div>
<div class="line">ZTMP2(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,:)=ZFPR(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,:,4)+ZFPR(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,:,5)</div>
<div class="line">CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMP2(:,:),&#39;FQTPRECISTN&#39;,YDDDH)</div>
</div><!-- fragment --><p>into:</p>
<div class="fragment"><div class="line">ZTMP2(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,0)=0._JPRB</div>
<div class="line">DO JLEV=1,YDCPG_OPTS%KFLEVG</div>
<div class="line">  ZTMP2(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,JLEV)=ZPFPR_(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,JLEV,2)+ZPFPR_(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,JLEV,4)</div>
<div class="line">ENDDO</div>
<div class="line">!ZTMP2(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,:)=ZFPR(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,:,2)+ZFPR(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,:,3)</div>
<div class="line">CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMP2(:,:),&#39;FQTPRECISTL&#39;,YDDDH)</div>
<div class="line">DO JLEV=1,YDCPG_OPTS%KFLEVG</div>
<div class="line">  ZTMP2(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,JLEV)=ZPFPR_(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,JLEV,4)+ZPFPR_(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,JLEV,5)</div>
<div class="line">ENDDO</div>
<div class="line">!ZTMP2(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,:)=ZFPR(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,:,4)+ZFPR(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,:,5)</div>
<div class="line">CALL NEW_ADD_FIELD_3D(YDMODEL%YRML_DIAG%YRMDDH,ZTMP2(:,:),&#39;FQTPRECISTN&#39;,YDDDH)</div>
</div><!-- fragment --><p>If cycle is 48t3 or 49t0, edition of apl_arome.F90 to:</p>
<p>add the folowing lines after the line 236 (YOMTRAJ use statement):</p>
<div class="fragment"><div class="line">#ifdef REPRO48</div>
<div class="line">!To compensate a bug introduced in 48t3</div>
<div class="line">!Must be suppressed as soon as the bug is corrected</div>
<div class="line">USE MODD_BUDGET</div>
<div class="line">#endif</div>
</div><!-- fragment --><p>and (still for 48t3) add the folowing lines at line 912 (to be one of the first execution statement but exact emplacement is not sensitive):</p>
<div class="fragment"><div class="line">#ifdef REPRO48</div>
<div class="line">!see comment associated to the MODD_BUDGET use statement</div>
<div class="line">LBU_ENABLE = YDMODEL%YRML_DIAG%YRLDDH%LSDDH</div>
<div class="line">LBUDGET_U =LBU_ENABLE</div>
<div class="line">LBUDGET_V =LBU_ENABLE</div>
<div class="line">LBUDGET_W =LBU_ENABLE</div>
<div class="line">LBUDGET_TH=LBU_ENABLE</div>
<div class="line">LBUDGET_TKE=LBU_ENABLE</div>
<div class="line">LBUDGET_RV=LBU_ENABLE</div>
<div class="line">LBUDGET_RC=LBU_ENABLE</div>
<div class="line">LBUDGET_RR =LBU_ENABLE</div>
<div class="line">LBUDGET_RI =LBU_ENABLE</div>
<div class="line">LBUDGET_RS =LBU_ENABLE</div>
<div class="line">LBUDGET_RG =LBU_ENABLE</div>
<div class="line">LBUDGET_RH =LBU_ENABLE</div>
<div class="line">LBUDGET_SV=LBU_ENABLE</div>
<div class="line">#endif</div>
</div><!-- fragment --><p>Edition of phyex/turb/compute_mf_cloud_bigaus.F90 to modify (line 120):</p>
<div class="fragment"><div class="line">DO JK=KKB,KKE,KKL</div>
</div><!-- fragment --><p>into:</p>
<div class="fragment"><div class="line">DO JK=KKB,KKE-KKL,KKL</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md90"></a>
Apply some bug corrections specific for 49t0</h2>
<p>Edition of arpifs/module/yemlbci_model.F90 to change (line 550):</p>
<div class="fragment"><div class="line">LUNBC=&gt;YDML_LBC%LSPTENC</div>
</div><!-- fragment --><p>into:</p>
<div class="fragment"><div class="line">LUNBC=&gt;YDML_LBC%LUNBC</div>
</div><!-- fragment --><p>In addition, the following files are modified:</p><ul>
<li>arpifs/adiab/cpg_pt_ulp_expl.fypp</li>
<li>arpifs/module/cpg_opts_type_mod.fypp</li>
<li>arpifs/module/field_variables_mod.fypp</li>
<li>arpifs/module/cpg_type_mod.fypp</li>
<li>arpifs/module/field_registry_mod.fypp</li>
<li>arpifs/module/mf_phys_next_state_type_mod.fypp</li>
</ul>
<p>The output of the diff command (diff main local): arpifs/adiab/cpg_pt_ulp_expl.fypp: </p><div class="fragment"><div class="line">110,114c110,116</div>
<div class="line">&lt;   DO JGFL = 1, SIZE (YDCPG_SL1%${v.name}$)</div>
<div class="line">&lt;     IF (YGFL%Y${v.name}$(JGFL)%LT1 .AND. YGFL%Y${v.name}$(JGFL)%LPT) THEN</div>
<div class="line">&lt;       YDA_GFLPT%P(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:NFLEVG,YGFL%Y${v.name}$(JGFL)%MPPT) = YDMF_PHYS_NEXT_STATE%${v.name}$(JGFL)%P(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:NFLEVG)</div>
<div class="line">&lt;     ENDIF</div>
<div class="line">&lt;   ENDDO</div>
<div class="line">---</div>
<div class="line">&gt;   IF (ALLOCATED (YDCPG_SL1%${v.name}$)) THEN</div>
<div class="line">&gt;     DO JGFL = 1, SIZE (YDCPG_SL1%${v.name}$)</div>
<div class="line">&gt;       IF (YGFL%Y${v.name}$(JGFL)%LT1 .AND. YGFL%Y${v.name}$(JGFL)%LPT) THEN</div>
<div class="line">&gt;         YDA_GFLPT%P(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:NFLEVG,YGFL%Y${v.name}$(JGFL)%MPPT) = YDMF_PHYS_NEXT_STATE%${v.name}$(JGFL)%P(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:NFLEVG)</div>
<div class="line">&gt;       ENDIF</div>
<div class="line">&gt;     ENDDO</div>
<div class="line">&gt;   ENDIF</div>
<div class="line">147,151c149,155</div>
<div class="line">&lt;   DO JGFL = 1, SIZE (YDCPG_SL1%${v.name}$)</div>
<div class="line">&lt;     IF (YGFL%Y${v.name}$(JGFL)%LT1 .AND. YGFL%Y${v.name}$(JGFL)%LPT) THEN</div>
<div class="line">&lt;       YDMF_PHYS_NEXT_STATE%${v.name}$(JGFL)%P(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:NFLEVG) = YDA_GFLPT%P(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:NFLEVG,YGFL%Y${v.name}$(JGFL)%MPPT)</div>
<div class="line">&lt;     ENDIF</div>
<div class="line">&lt;   ENDDO</div>
<div class="line">---</div>
<div class="line">&gt;   IF (ALLOCATED (YDCPG_SL1%${v.name}$)) THEN</div>
<div class="line">&gt;     DO JGFL = 1, SIZE (YDCPG_SL1%${v.name}$)</div>
<div class="line">&gt;       IF (YGFL%Y${v.name}$(JGFL)%LT1 .AND. YGFL%Y${v.name}$(JGFL)%LPT) THEN</div>
<div class="line">&gt;         YDMF_PHYS_NEXT_STATE%${v.name}$(JGFL)%P(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:NFLEVG) = YDA_GFLPT%P(YDCPG_BNDS%KIDIA:YDCPG_BNDS%KFDIA,1:NFLEVG,YGFL%Y${v.name}$(JGFL)%MPPT)</div>
<div class="line">&gt;       ENDIF</div>
<div class="line">&gt;     ENDDO</div>
<div class="line">&gt;   ENDIF</div>
</div><!-- fragment --><p>arpifs/module/cpg_opts_type_mod.fypp: </p><div class="fragment"><div class="line">248a249</div>
<div class="line">&gt;     IF (ALLOCATED (XPNUDG)) THEN</div>
<div class="line">249a251</div>
<div class="line">&gt;     ENDIF</div>
</div><!-- fragment --><p>arpifs/module/field_variables_mod.fypp: </p><div class="fragment"><div class="line">183,187c183,189</div>
<div class="line">&lt;     DO JFLD = 1, SIZE (SELF%${v.name}$)</div>
<div class="line">&lt;       SELF%GFL_PTR (IPNTR)%YV =&gt; SELF%${v.name}$(JFLD)</div>
<div class="line">&lt;       SELF%GFL_PTR (IPNTR)%YCOMP = SELF%${v.name}$(JFLD)%YCOMP</div>
<div class="line">&lt;       IPNTR = IPNTR + 1</div>
<div class="line">&lt;     ENDDO</div>
<div class="line">---</div>
<div class="line">&gt;     IF (ASSOCIATED (SELF%${v.name}$)) THEN</div>
<div class="line">&gt;       DO JFLD = 1, SIZE (SELF%${v.name}$)</div>
<div class="line">&gt;         SELF%GFL_PTR (IPNTR)%YV =&gt; SELF%${v.name}$(JFLD)</div>
<div class="line">&gt;         SELF%GFL_PTR (IPNTR)%YCOMP = SELF%${v.name}$(JFLD)%YCOMP</div>
<div class="line">&gt;         IPNTR = IPNTR + 1</div>
<div class="line">&gt;       ENDDO</div>
<div class="line">&gt;     ENDIF</div>
</div><!-- fragment --><p>arpifs/module/cpg_type_mod.fypp: </p><div class="fragment"><div class="line">467,469c467,471</div>
<div class="line">&lt; DO JFLD = 1, SIZE (YDCPG_SL1%${v.name}$)</div>
<div class="line">&lt;   IF (COND (YDMODEL%YRML_GCONF%YGFL%Y${v.name}$(JFLD), YDMODEL)) ISIZE = ISIZE + 1</div>
<div class="line">&lt; ENDDO</div>
<div class="line">---</div>
<div class="line">&gt; IF (ALLOCATED (YDCPG_SL1%${v.name}$)) THEN</div>
<div class="line">&gt;   DO JFLD = 1, SIZE (YDCPG_SL1%${v.name}$)</div>
<div class="line">&gt;     IF (COND (YDMODEL%YRML_GCONF%YGFL%Y${v.name}$(JFLD), YDMODEL)) ISIZE = ISIZE + 1</div>
<div class="line">&gt;   ENDDO</div>
<div class="line">&gt; ENDIF</div>
<div class="line">481,486c483,490</div>
<div class="line">&lt; DO JFLD = 1, SIZE (YDCPG_SL1%${v.name}$)</div>
<div class="line">&lt;   IF (COND (YDMODEL%YRML_GCONF%YGFL%Y${v.name}$(JFLD), YDMODEL)) THEN</div>
<div class="line">&lt;     YDVARS_LIST (IPNTR) = YDCPG_SL1%${v.name}$(JFLD)</div>
<div class="line">&lt;     IPNTR = IPNTR + 1</div>
<div class="line">&lt;   ENDIF</div>
<div class="line">&lt; ENDDO</div>
<div class="line">---</div>
<div class="line">&gt; IF (ALLOCATED (YDCPG_SL1%${v.name}$)) THEN</div>
<div class="line">&gt;   DO JFLD = 1, SIZE (YDCPG_SL1%${v.name}$)</div>
<div class="line">&gt;     IF (COND (YDMODEL%YRML_GCONF%YGFL%Y${v.name}$(JFLD), YDMODEL)) THEN</div>
<div class="line">&gt;       YDVARS_LIST (IPNTR) = YDCPG_SL1%${v.name}$(JFLD)</div>
<div class="line">&gt;       IPNTR = IPNTR + 1</div>
<div class="line">&gt;     ENDIF</div>
<div class="line">&gt;   ENDDO</div>
<div class="line">&gt; ENDIF</div>
<div class="line">584c588,589</div>
<div class="line">&lt; ALLOCATE (SELF%${v.name}$ (SIZE (YGFL%Y${v.name}$)))</div>
<div class="line">---</div>
<div class="line">&gt; IF (ASSOCIATED (YGFL%Y${v.name}$)) THEN</div>
<div class="line">&gt;   ALLOCATE (SELF%${v.name}$ (SIZE (YGFL%Y${v.name}$)))</div>
<div class="line">586,588c591,594</div>
<div class="line">&lt; DO JGFL = 1, SIZE (YGFL%Y${v.name}$)</div>
<div class="line">&lt;   CALL CPG_SL1_TYPE_INIT_F3D (SELF%${v.name}$(JGFL), YGFL%Y${v.name}$(JGFL))</div>
<div class="line">&lt; ENDDO</div>
<div class="line">---</div>
<div class="line">&gt;   DO JGFL = 1, SIZE (YGFL%Y${v.name}$)</div>
<div class="line">&gt;     CALL CPG_SL1_TYPE_INIT_F3D (SELF%${v.name}$(JGFL), YGFL%Y${v.name}$(JGFL))</div>
<div class="line">&gt;   ENDDO</div>
<div class="line">&gt; ENDIF</div>
<div class="line">690,692c696,700</div>
<div class="line">&lt;   DO JGFL = 1, SIZE (SELF%${v.name}$)</div>
<div class="line">&lt;     CALL CPG_SL1_TYPE_UPDATE_VIEW_F3D (SELF%${v.name}$(JGFL))</div>
<div class="line">&lt;   ENDDO</div>
<div class="line">---</div>
<div class="line">&gt;   IF (ALLOCATED (SELF%${v.name}$)) THEN</div>
<div class="line">&gt;     DO JGFL = 1, SIZE (SELF%${v.name}$)</div>
<div class="line">&gt;       CALL CPG_SL1_TYPE_UPDATE_VIEW_F3D (SELF%${v.name}$(JGFL))</div>
<div class="line">&gt;     ENDDO</div>
<div class="line">&gt;   ENDIF</div>
<div class="line">713,715c721,725</div>
<div class="line">&lt;   DO JGFL = 1, SIZE (SELF%${v.name}$)</div>
<div class="line">&lt;     CALL NULLIFY_F3D (SELF%${v.name}$(JGFL))</div>
<div class="line">&lt;   ENDDO</div>
<div class="line">---</div>
<div class="line">&gt;   IF (ALLOCATED (SELF%${v.name}$)) THEN</div>
<div class="line">&gt;     DO JGFL = 1, SIZE (SELF%${v.name}$)</div>
<div class="line">&gt;       CALL NULLIFY_F3D (SELF%${v.name}$(JGFL))</div>
<div class="line">&gt;     ENDDO</div>
<div class="line">&gt;   ENDIF</div>
<div class="line">812,814c822,826</div>
<div class="line">&lt; DO JGFL = 1, SIZE (SELF%${v.name}$)</div>
<div class="line">&lt;   CALL CPG_SL1_TYPE_FINAL_F3D (SELF%${v.name}$(JGFL))</div>
<div class="line">&lt; ENDDO</div>
<div class="line">---</div>
<div class="line">&gt; IF (ALLOCATED (SELF%${v.name}$)) THEN</div>
<div class="line">&gt;   DO JGFL = 1, SIZE (SELF%${v.name}$)</div>
<div class="line">&gt;     CALL CPG_SL1_TYPE_FINAL_F3D (SELF%${v.name}$(JGFL))</div>
<div class="line">&gt;   ENDDO</div>
<div class="line">&gt; ENDIF</div>
</div><!-- fragment --><p>arpifs/module/field_registry_mod.fypp: </p><div class="fragment"><div class="line">705,707c705,709</div>
<div class="line">&lt;     DO JFLD = 1, SIZE (VARIABLES%${v.name}$)</div>
<div class="line">&lt;       IF (COND (VARIABLES%${v.name}$(JFLD), YDMODEL%YRML_GCONF%YGFL%Y${v.name}$(JFLD), YDMODEL)) ISIZE = ISIZE + 1</div>
<div class="line">&lt;     ENDDO</div>
<div class="line">---</div>
<div class="line">&gt;     IF (ASSOCIATED (VARIABLES%${v.name}$)) THEN</div>
<div class="line">&gt;       DO JFLD = 1, SIZE (VARIABLES%${v.name}$)</div>
<div class="line">&gt;         IF (COND (VARIABLES%${v.name}$(JFLD), YDMODEL%YRML_GCONF%YGFL%Y${v.name}$(JFLD), YDMODEL)) ISIZE = ISIZE + 1</div>
<div class="line">&gt;       ENDDO</div>
<div class="line">&gt;     ENDIF</div>
<div class="line">719,725c721,729</div>
<div class="line">&lt;     DO JFLD = 1, SIZE (VARIABLES%${v.name}$)</div>
<div class="line">&lt;       IF (COND (VARIABLES%${v.name}$(JFLD), YDMODEL%YRML_GCONF%YGFL%Y${v.name}$(JFLD), YDMODEL)) THEN</div>
<div class="line">&lt;         YDVARS_LIST (IPNTR)%YV =&gt; VARIABLES%${v.name}$(JFLD)</div>
<div class="line">&lt;         YDVARS_LIST (IPNTR)%YCOMP = VARIABLES%${v.name}$(JFLD)%YCOMP</div>
<div class="line">&lt;         IPNTR = IPNTR + 1</div>
<div class="line">&lt;       ENDIF</div>
<div class="line">&lt;     ENDDO</div>
<div class="line">---</div>
<div class="line">&gt;     IF (ASSOCIATED (VARIABLES%${v.name}$)) THEN</div>
<div class="line">&gt;       DO JFLD = 1, SIZE (VARIABLES%${v.name}$)</div>
<div class="line">&gt;         IF (COND (VARIABLES%${v.name}$(JFLD), YDMODEL%YRML_GCONF%YGFL%Y${v.name}$(JFLD), YDMODEL)) THEN</div>
<div class="line">&gt;           YDVARS_LIST (IPNTR)%YV =&gt; VARIABLES%${v.name}$(JFLD)</div>
<div class="line">&gt;           YDVARS_LIST (IPNTR)%YCOMP = VARIABLES%${v.name}$(JFLD)%YCOMP</div>
<div class="line">&gt;           IPNTR = IPNTR + 1</div>
<div class="line">&gt;         ENDIF</div>
<div class="line">&gt;       ENDDO</div>
<div class="line">&gt;     ENDIF</div>
</div><!-- fragment --><p>arpifs/module/mf_phys_next_state_type_mod.fypp: </p><div class="fragment"><div class="line">127,130c127,132</div>
<div class="line">&lt;     ALLOCATE (SELF%${v.name}$ (SIZE (YDVARS%${v.name}$)))</div>
<div class="line">&lt;     DO JGFL = 1, SIZE (YDVARS%${v.name}$)</div>
<div class="line">&lt;       CALL MF_PHYS_NEXT_STATE_TYPE_INIT_SPLTHOI_3D (YDVARS%${v.name}$(JGFL), SELF%${v.name}$(JGFL), YDCPG_SL1%${v.name}$(JGFL))</div>
<div class="line">&lt;     ENDDO</div>
<div class="line">---</div>
<div class="line">&gt;     IF (ASSOCIATED (YDVARS%${v.name}$)) THEN</div>
<div class="line">&gt;       ALLOCATE (SELF%${v.name}$ (SIZE (YDVARS%${v.name}$)))</div>
<div class="line">&gt;       DO JGFL = 1, SIZE (YDVARS%${v.name}$)</div>
<div class="line">&gt;         CALL MF_PHYS_NEXT_STATE_TYPE_INIT_SPLTHOI_3D (YDVARS%${v.name}$(JGFL), SELF%${v.name}$(JGFL), YDCPG_SL1%${v.name}$(JGFL))</div>
<div class="line">&gt;       ENDDO</div>
<div class="line">&gt;     ENDIF</div>
<div class="line">138,141c140,145</div>
<div class="line">&lt;     ALLOCATE (SELF%${v.name}$ (SIZE (YDVARS%${v.name}$)))</div>
<div class="line">&lt;     DO JGFL = 1, SIZE (YDVARS%${v.name}$)</div>
<div class="line">&lt;       CALL MF_PHYS_NEXT_STATE_TYPE_INIT_3D (YDVARS%${v.name}$(JGFL), SELF%${v.name}$(JGFL), YDCPG_SL1%${v.name}$(JGFL))</div>
<div class="line">&lt;     ENDDO</div>
<div class="line">---</div>
<div class="line">&gt;     IF (ASSOCIATED (YDVARS%${v.name}$)) THEN</div>
<div class="line">&gt;       ALLOCATE (SELF%${v.name}$ (SIZE (YDVARS%${v.name}$)))</div>
<div class="line">&gt;       DO JGFL = 1, SIZE (YDVARS%${v.name}$)</div>
<div class="line">&gt;         CALL MF_PHYS_NEXT_STATE_TYPE_INIT_3D (YDVARS%${v.name}$(JGFL), SELF%${v.name}$(JGFL), YDCPG_SL1%${v.name}$(JGFL))</div>
<div class="line">&gt;       ENDDO</div>
<div class="line">&gt;     ENDIF</div>
<div class="line">163,166c167,172</div>
<div class="line">&lt;   ALLOCATE (SELF%${v.name}$ (SIZE (YDVARS%${v.name}$)))</div>
<div class="line">&lt;   DO JGFL = 1, SIZE (YDVARS%${v.name}$)</div>
<div class="line">&lt;     CALL MF_PHYS_NEXT_STATE_TYPE_INIT_EUL_3D (YDVARS%${v.name}$(JGFL), SELF%${v.name}$(JGFL))</div>
<div class="line">&lt;   ENDDO</div>
<div class="line">---</div>
<div class="line">&gt;   IF (ASSOCIATED (YDVARS%${v.name}$)) THEN</div>
<div class="line">&gt;     ALLOCATE (SELF%${v.name}$ (SIZE (YDVARS%${v.name}$)))</div>
<div class="line">&gt;     DO JGFL = 1, SIZE (YDVARS%${v.name}$)</div>
<div class="line">&gt;       CALL MF_PHYS_NEXT_STATE_TYPE_INIT_EUL_3D (YDVARS%${v.name}$(JGFL), SELF%${v.name}$(JGFL))</div>
<div class="line">&gt;     ENDDO</div>
<div class="line">&gt;   ENDIF</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md91"></a>
Compilation</h2>
<div class="fragment"><div class="line">cd $TRUNK/tools/pack/${cycle}_phyex.${version}.${compiler}.${option}</div>
<div class="line">Edition of .gmkfile/${gmkfile} to add -DREPRO48 to the MACROS_FRT variable in order to suppress bug corrections and be able to reproduce the original cy48</div>
<div class="line">sed -i &#39;s/GMK_THREADS=1/GMK_THREADS=10/&#39; ics_masterodb</div>
<div class="line">cleanpack -f</div>
<div class="line">resetpack -f</div>
<div class="line">./ics_masterodb</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md92"></a>
USER\'S PACK CREATION</h1>
<div class="fragment"><div class="line">version=01</div>
<div class="line">compiler=MPIGFORTRAN920DBL on ubuntu, MIMPIIFC1805 on belenos</div>
<div class="line">gmkfile=${compiler}.GMAP on ubuntu, ${compiler}.EPONA on belenos</div>
<div class="line">option=xfftw on ubuntu, 2y on belenos</div>
<div class="line"> </div>
<div class="line">commit=9ce8119430dd603d35308d8ae94cf18636157473 #exemple of commit to test against the reference pack</div>
<div class="line"> </div>
<div class="line">gmkpack -r ${cycle} -b phyex -v ${version} -l ${compiler} -o ${option} -p masterodb -f $TRUNK -u PHYEX/$commit</div>
<div class="line"> </div>
<div class="line">cd $HOMEPACK/PHYEX/$commit/src/local/phyex</div>
<div class="line">git clone git@github.com:UMR-CNRM/PHYEX.git</div>
<div class="line">cd PHYEX</div>
<div class="line">git checkout $commit</div>
<div class="line">#The exact manipulation to perform depends on the commit to test. For a full description, please see the check_commit_ial.sh script</div>
<div class="line">for rep in turb micro conv; do</div>
<div class="line">  mv -f src/common/$rep/* ../$rep/</div>
<div class="line">  mv -f src/arome/$rep/* ../$rep/</div>
<div class="line">  touch ../$rep/*</div>
<div class="line">done</div>
<div class="line">cd ..</div>
<div class="line">rm -rf PHYEX</div>
<div class="line"> </div>
<div class="line">cd $HOMEPACK/PHYEX/$commit</div>
<div class="line">sed -i &#39;s/GMK_THREADS=1/GMK_THREADS=10/&#39; ics_masterodb</div>
<div class="line">cleanpack -f</div>
<div class="line">./ics_masterodb</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
