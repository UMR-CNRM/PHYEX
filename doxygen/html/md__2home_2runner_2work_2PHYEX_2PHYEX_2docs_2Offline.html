<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PHYEX: PHYEX OFFLINE DOCUMENTATION</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">PHYEX
   </div>
   <div id="projectbrief">PHYsique EXternalis√©e</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">PHYEX OFFLINE DOCUMENTATION</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md55"></a> </p>
<h1><a class="anchor" id="autotoc_md56"></a>
About this section</h1>
<p>This document is intended for persons who want to use PHYEX in an offline mode. Some offline test programs are provided with the package and a library suitable for use with python is also available.</p>
<h1><a class="anchor" id="autotoc_md57"></a>
Compilation</h1>
<p>The compilation can be achieved using different build systems. In the following explanations, the build system name is replaced by &lt;bs&gt;.</p>
<p>The PHYEX source code needs the <a href="https://github.com/ecmwf-ifs/fiat">fiat</a> package installation is done automatically by the compilation script).</p>
<p>The different build/with_&lt;bs&gt; directories in the master branch contains the build environments.</p>
<p>The <a href="https://metomi.github.io/fcm/doc/user_guide/">fcm</a> build system needs to be installed, this is done automatically by the compilation script.</p>
<p>The script build/with_&lt;bs&gt;/make_&lt;bs&gt;.sh uses configuration files and build the library and test programs. These executables can be found in the build/bin subdirectory in the architecture specific directory arch_&lt;architecture name&gt;.</p>
<p>Some configuration files are stored in build/with_&lt;bs&gt;/arch but other can be maintained by the end users in their ${HOME}/.phyex/&lt;bs&gt;_arch.</p>
<p>Some more details on the build system can be found in build/README.md file.</p>
<h2><a class="anchor" id="autotoc_md58"></a>
Compilation directly in the repository without execution (or manual execution)</h2>
<p>When on a master commit, the build/with_&lt;bs&gt;/make_&lt;bs&gt;.sh script can be used to compile the offline tools.</p>
<h2><a class="anchor" id="autotoc_md59"></a>
Compilation and execution</h2>
<p>When on a master commit, the tools/check_commit_testprogs.sh script can be used to compile and execute the testprogs (offline tests). The check_commit_testprogs.sh script uses the PHYEX source code:</p>
<ul>
<li>of a specific commit on the master branch available on a remote repository</li>
<li>or, the last commit of a offline_&lt;commit_hash&gt; branch available on a remote repository</li>
<li>or, the content of a local repository.</li>
</ul>
<p>In the latter case, it can be interesting to clone the PHYEX repository twice. A first one to have the build tools on the master branch, and a second one to checkout the source code version to use. This solution is especially useful when working on a offline_&lt;commit_hash&gt; branch (because these branches does not contain the build tools).</p>
<p>Something like this can be used:</p>
<ul>
<li>cd $HOME; git clone &lt;PHYEX url&gt; PHYEXtools</li>
<li>cd PHYEXtools; git checkout master</li>
<li>cd $HOME; git clone &lt;PHYEX url&gt; PHYEX</li>
<li>cd PHYEX; git checkout arome_&lt;commit_hash&gt;; source code moddifications...</li>
<li>. PHYEXtools/tools/env.sh; check_commit_testprogs.sh $HOME/PHYEX REF</li>
</ul>
<p>The last step will create a directory (in $HOME/TESTPROGS) with a copy of your source code and the build system, builds the testprogs and executes them.</p>
<h1><a class="anchor" id="autotoc_md60"></a>
Test program</h1>
<h2><a class="anchor" id="autotoc_md61"></a>
Data generation</h2>
<p>The branch testprogs_data contains modified source code for the AROME model to enable the generation of data samples for the turb, shallow, rain_ice and ice_adjust testprogs. The branch testprogs_data2 contains modified source code for the AROME model to enable the generation of data samples for the rain_ice_old testprog. The branch testprogs_data3 contains modified source code for the AROME model to enable the generation of data samples for the lima and lima_adjust testprogs. Using these branches, in the drivers of the different parametrisations (aro_* files), output can be enable for the AROME model. Running the AROME model with these modifications outputs files in the running directory. This must be done once by parametrisation (note that the check_commit_ial.sh script can be used to execute an AROME simulation).</p>
<p>These files should be renamed with the following command: i=0; for file in ????_??_????????.dat; do mv $file <code>printf %08d $i</code>.dat; i=$((i+1)); done</p>
<h2><a class="anchor" id="autotoc_md62"></a>
Usage directly with the testprogs executables</h2>
<p>The different main_*.exe programs obtained by the compilation can be run. Each of these executables is expecting the presence of a 'data' directory in their working directory containing the different files.</p>
<h2><a class="anchor" id="autotoc_md63"></a>
Usage through the check_commit_testprogs.sh script</h2>
<p>As described in COMPILATION.</p>
<h1><a class="anchor" id="autotoc_md64"></a>
Python bindings</h1>
<p>The package includes a python binding to call the main subroutines of PHYEX. Using the default gfortran compiler, the needed compilation is achieved with:</p>
<ul>
<li>. PHYEX/tools/env.sh</li>
<li>cd PHYEX/build/with_fcm</li>
<li>./make_fcm.sh</li>
</ul>
<p>This builds a shared library and writes a python wrapper. This script needs the ctypesForFortran package (available on PyPI). And it can be used like in this example for ice_adjust (the sourcing of PHYEX/tools/env.sh is also needed at this step):</p>
<div class="fragment"><div class="line">#!/usr/bin/env python3</div>
<div class="line"> </div>
<div class="line">&quot;&quot;&quot;</div>
<div class="line">Offline python binding example, valid with a June 2024 version of PHYEX</div>
<div class="line">&quot;&quot;&quot;</div>
<div class="line"> </div>
<div class="line">import tempfile</div>
<div class="line">from pyphyex import PYICE_ADJUST, PYINI_PHYEX, close</div>
<div class="line">import numpy</div>
<div class="line">from matplotlib import pyplot as plt</div>
<div class="line">import f90nml</div>
<div class="line"> </div>
<div class="line">#Config</div>
<div class="line">NIT, NKT = 150, 100</div>
<div class="line">VSIGQSAT = 0.02</div>
<div class="line">PSIGS = numpy.ones((NKT, NIT)) * 0.0005</div>
<div class="line">PPABST = numpy.ones((NKT, NIT)) * 101325.</div>
<div class="line">PRC = numpy.zeros((NKT, NIT))</div>
<div class="line">PRI = numpy.zeros((NKT, NIT))</div>
<div class="line">PRV = numpy.linspace(0.003, 0.01, num=NKT)</div>
<div class="line">PTH = numpy.linspace(280., 295., num=NIT)</div>
<div class="line">PTH, PRV = numpy.meshgrid(PTH, PRV)</div>
<div class="line"> </div>
<div class="line">#Other values</div>
<div class="line">PTSTEP = 60.</div>
<div class="line">PROGRAM = &#39;AROME&#39;</div>
<div class="line">HBUNAME = &#39;DEPO&#39;</div>
<div class="line">NKL, NVEXT, KRR = 1, 0, 6</div>
<div class="line">PSIGQSAT = numpy.ones((NIT,)) * VSIGQSAT</div>
<div class="line">PRHODJ = numpy.ones((NKT, NIT))</div>
<div class="line">PEXNREF = numpy.ones((NKT, NIT))</div>
<div class="line">PEXN = numpy.ones((NKT, NIT))</div>
<div class="line">PRHODREF = numpy.ones((NKT, NIT))</div>
<div class="line">LMFCONV = False</div>
<div class="line">PMFCONV = numpy.zeros((NKT, NIT))</div>
<div class="line">PZZ = numpy.zeros((NKT, NIT))</div>
<div class="line">PCF_MF = numpy.zeros((NKT, NIT))</div>
<div class="line">PRC_MF = numpy.zeros((NKT, NIT))</div>
<div class="line">PRI_MF = numpy.zeros((NKT, NIT))</div>
<div class="line">OCOMPUTE_SRC = True</div>
<div class="line">PRR = numpy.zeros((NKT, NIT))</div>
<div class="line">PRS = numpy.zeros((NKT, NIT))</div>
<div class="line">PRG = numpy.zeros((NKT, NIT))</div>
<div class="line">KBUDGETS = 0</div>
<div class="line"> </div>
<div class="line">with tempfile.NamedTemporaryFile() as f:</div>
<div class="line">    nml = f90nml.read(f.name)</div>
<div class="line">    nml[&#39;NAM_NEBn&#39;] = {}</div>
<div class="line">    nml[&#39;NAM_NEBn&#39;][&#39;CCONDENS&#39;] = &#39;CB02&#39;</div>
<div class="line">    nml[&#39;NAM_NEBn&#39;][&#39;LSUBG_COND&#39;] = True</div>
<div class="line">    nml[&#39;NAM_NEBn&#39;][&#39;LSIGMAS&#39;] = True</div>
<div class="line">    nml.write(f.name, force=True)</div>
<div class="line">    PYINI_PHYEX(PROGRAM, 33, f.name, False, 20, 0, 1, PTSTEP, 20., &#39;ICE3&#39;, &#39;EDKF&#39;, &#39;TKEL&#39;,</div>
<div class="line">                LDCHANGEMODEL=True, LDDEFAULTVAL=True, LDREADNAM=True, LDCHECK=True,</div>
<div class="line">                KPRINT=0, LDINIT=True)</div>
<div class="line">PRVS = PRV / PTSTEP</div>
<div class="line">PRCS = PRC / PTSTEP</div>
<div class="line">PRIS = PRI / PTSTEP</div>
<div class="line">PTHS = PTH / PTSTEP</div>
<div class="line">result = PYICE_ADJUST(NIT, NKT, NKL, NVEXT, KRR, HBUNAME, PTSTEP, PSIGQSAT, PRHODJ,</div>
<div class="line">                      PEXNREF, PRHODREF, PSIGS, LMFCONV, PMFCONV, PPABST, PZZ, PEXN,</div>
<div class="line">                      PCF_MF, PRC_MF, PRI_MF, PRV, PRC, PRVS, PRCS, PTH, PTHS,</div>
<div class="line">                      OCOMPUTE_SRC, PRR, PRI, PRIS, PRS, PRG, KBUDGETS)</div>
<div class="line">(_, _, _, _, _, PRVS, PRCS, PTHS, PSRCS, PCLDFR, PRIS,</div>
<div class="line"> POUT_RV, POUT_RC, POUT_RI, POUT_TH, PHLC_HRC, PHLC_HCF, PHLI_HRI, PHLI_HCF) = result</div>
<div class="line">PRC = PRCS / PTSTEP</div>
<div class="line"> </div>
<div class="line">close()</div>
<div class="line"> </div>
<div class="line">fig, ax = plt.subplots(ncols=2, sharex=True, sharey=True)</div>
<div class="line"> </div>
<div class="line">cf = ax[0].contourf(PRV, PTH, PRC, levels=numpy.linspace(0., 5.6E-7, 15))</div>
<div class="line">fig.colorbar(cf, ax=ax[0])</div>
<div class="line">ax[0].set_title(&#39;Cloud mixing ratio (kg/kg)&#39;)</div>
<div class="line">ax[0].set_ylabel(&#39;Potential temperature (K)&#39;)</div>
<div class="line">ax[0].set_xlabel(&#39;Total water mixing ratio (kg/kg)&#39;)</div>
<div class="line"> </div>
<div class="line">cf = ax[1].contourf(PRV, PTH, PCLDFR, levels=numpy.linspace(0., 1., 15))</div>
<div class="line">fig.colorbar(cf, ax=ax[1])</div>
<div class="line">ax[1].set_title(&#39;Cloud fraction (0-1)&#39;)</div>
<div class="line">ax[1].set_xlabel(&#39;Total water mixing ratio (kg/kg)&#39;)</div>
<div class="line"> </div>
<div class="line">plt.show()</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
